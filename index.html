<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>PiggyBank Pro</title>
    
    <!-- PWA Config -->
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" type="image/png" href="https://img.icons8.com/color/96/pig-with-lipstick.png">
    <link rel="apple-touch-icon" href="https://img.icons8.com/color/180/pig-with-lipstick.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#f8fafc">

    <!-- CDN Deps -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&display=swap" rel="stylesheet">
    
    <style>
        /* Fix Bug 3: Safe Area for Mobile Status Bar */
        body { 
            font-family: 'Fredoka', sans-serif; 
            background-color: #f8fafc; 
            -webkit-tap-highlight-color: transparent; 
            overscroll-behavior-y: none;
            padding-top: max(1rem, env(safe-area-inset-top)); 
        }

        .tab-content { display: none; opacity: 0; animation: fadeIn 0.3s forwards; } 
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Bottom Nav Fix */
        #bottom-nav { padding-bottom: max(1rem, env(safe-area-inset-bottom)); }

        .nav-btn { color: #94a3b8; transition: all 0.2s; }
        .nav-btn.active { color: #4f46e5; transform: scale(1.1); }
        .nav-indicator { height: 4px; width: 0; background: #4f46e5; border-radius: 9px; margin: 2px auto 0; transition: width 0.3s; }
        .nav-btn.active .nav-indicator { width: 20px; }

        #toast-container { position: fixed; top: 40px; left: 50%; transform: translateX(-50%); z-index: 10000; display: flex; flex-direction: column; gap: 8px; pointer-events: none; width: 90%; max-width: 320px; }
        .toast { background: rgba(15, 23, 42, 0.95); color: white; padding: 12px 20px; border-radius: 99px; box-shadow: 0 10px 20px rgba(0,0,0,0.15); animation: slideDown 0.3s forwards; pointer-events: auto; font-size: 13px; font-weight: 600; text-align: center; }
        .toast.error { background: rgba(220, 38, 38, 0.95); }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }

        .loader-overlay { display: flex; position: fixed; inset: 0; background: #f8fafc; z-index: 9999; align-items: center; justify-content: center; flex-direction: column; gap: 15px; }
        .modal { display: none; position: fixed; inset: 0; z-index: 50; align-items: center; justify-content: center; backdrop-filter: blur(2px); background-color: rgba(0,0,0,0.6); padding-top: max(2rem, env(safe-area-inset-top)); }
        .modal.open { display: flex; }
        .modal-box { padding: 1.25rem; width: 90%; max-width: 20rem; border-radius: 1.5rem; background: white; margin: auto; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); max-height: 85vh; overflow-y: auto; }
        
        .scroll-area { max-height: calc(100vh - 380px); overflow-y: auto; scrollbar-width: none; }
        
        .disabled-claim { background: #e2e8f0 !important; color: #94a3b8 !important; pointer-events: none; transform: none !important; box-shadow: none !important; animation: none !important; }
        .input-error { border: 2px solid #ef4444 !important; background-color: #fef2f2 !important; animation: shake 0.4s ease-in-out; }
        .ratio-err { color: #ef4444 !important; animation: pulse 1s infinite; }

        .acc-btn { border: 2px solid #e2e8f0; transition: all 0.2s; position: relative; overflow: hidden; background: white; opacity: 0.7; color: #64748b; }
        .acc-btn.selected { border-color: #4f46e5; background-color: #eef2ff; color: #4f46e5; transform: scale(1.02); opacity: 1; box-shadow: 0 4px 10px -2px rgba(79, 70, 229, 0.2); border-width: 2px; }
        .acc-btn .check-icon { display: none; }
        .acc-btn.selected .check-icon { display: block; position: absolute; top: 2px; right: 2px; font-size: 10px; }

        .cat-btn { border: 2px solid #f1f5f9; transition: all 0.2s; opacity: 0.7; transform: scale(0.95); }
        .cat-btn.selected { border-color: #4f46e5; background-color: #eef2ff; opacity: 1; transform: scale(1.1); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }

        .avatar-btn { font-size: 2rem; padding: 5px; border-radius: 50%; opacity: 0.6; transition: all 0.2s; border: 2px solid transparent; }
        .avatar-btn.selected { opacity: 1; transform: scale(1.2); border-color: #4f46e5; background: #eef2ff; }
        
        .check-status { font-size: 10px; font-weight: bold; margin-top: 2px; height: 14px; }
        .check-status.checking { color: #f59e0b; }
        .check-status.valid { color: #10b981; }
        .check-status.invalid { color: #ef4444; }
    </style>
</head>
<body class="pb-24 select-none text-slate-800 loading">
    <div id="toast-container"></div>
    <div id="global-loader" class="loader-overlay">
        <div class="text-6xl animate-bounce">ğŸ·</div>
        <div id="loader-msg" class="text-sm font-bold text-slate-500">Starting PWA...</div>
    </div>

    <!-- 1. AUTH SCREEN -->
    <div id="auth-screen" class="min-h-screen hidden flex flex-col items-center justify-center p-6 bg-slate-50">
        <div class="text-center mb-10 text-indigo-600"><div class="text-7xl mb-4">ğŸ·</div><h1 class="text-4xl font-black">PiggyBank</h1></div>
        <div class="w-full max-w-sm bg-white p-8 rounded-[2.5rem] shadow-xl">
            <input type="text" id="login-code" placeholder="PIN CODE" class="w-full p-4 bg-slate-100 rounded-2xl text-center text-2xl font-black tracking-widest outline-none mb-3 uppercase focus:ring-2 ring-indigo-500 transition-all">
            <input type="email" id="login-email" placeholder="Email" class="w-full p-4 bg-slate-100 rounded-2xl text-center font-bold outline-none mb-6 focus:ring-2 ring-indigo-500 transition-all">
            <button id="login-btn" onclick="handleLogin()" class="w-full bg-indigo-600 text-white py-5 rounded-2xl font-bold text-lg shadow-lg active:scale-95 transition-transform disabled:opacity-50">Unlock</button>
            <button onclick="goToSignup()" class="w-full mt-4 text-indigo-500 font-bold text-sm">Create New Family âœ¨</button>
        </div>
    </div>

    <!-- 2. SIGNUP WIZARD -->
    <!-- Fix Bug 3: Safe padding top -->
    <div id="signup-screen" class="hidden fixed inset-0 bg-white z-50 p-6 overflow-y-auto" style="padding-top: max(2rem, env(safe-area-inset-top));">
        <div class="max-w-md mx-auto">
            <button onclick="goToAuth()" class="mb-4 px-4 py-2 bg-slate-100 rounded-full text-xs font-bold text-slate-500">â¬… Back</button>
            <div id="step-1">
                <h2 class="text-2xl font-black text-indigo-600 mb-6">Create Account</h2>
                <div class="space-y-4">
                    <input id="reg-family-name" placeholder="Family Name" class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none border border-slate-200">
                    <div class="flex gap-2">
                        <input id="reg-email" type="email" placeholder="Parent Email" class="flex-1 p-4 bg-slate-50 rounded-2xl font-bold outline-none border border-slate-200">
                        <button id="otp-btn" onclick="sendOTP()" class="bg-indigo-600 text-white px-4 rounded-2xl font-bold text-sm whitespace-nowrap min-w-[90px]">Get Code</button>
                    </div>
                    <input id="reg-otp" type="number" placeholder="Code" class="w-full p-4 bg-slate-50 rounded-2xl font-black text-center tracking-widest text-xl outline-none border border-slate-200">
                    <button onclick="verifyOTP()" class="w-full bg-slate-800 text-white py-4 rounded-2xl font-bold text-lg shadow-xl mt-2">Verify â¡</button>
                </div>
            </div>
            <div id="step-2" class="hidden animate-in slide-in-from-right duration-300">
                <h2 class="text-2xl font-black text-indigo-600 mb-2">Setup Profile</h2>
                <div class="space-y-6">
                    <div class="bg-indigo-50 p-5 rounded-[2rem] border border-indigo-100">
                        <label class="text-xs font-bold text-indigo-400 uppercase tracking-wider block mb-2">Parent Admin PIN</label>
                        <input id="reg-parent-pin" placeholder="P888" class="w-full p-3 bg-white text-indigo-600 rounded-xl font-black text-center text-2xl tracking-widest outline-none uppercase border-2 border-transparent focus:border-indigo-500" maxlength="6">
                    </div>
                    <div id="children-list" class="space-y-4"></div>
                    <!-- Fix Bug 6: Better Child Add UX -->
                    <button onclick="addChildRow('children-list')" class="w-full py-3 border-2 border-dashed border-slate-300 text-slate-400 font-bold rounded-2xl">+ Add Child</button>
                    <button onclick="registerFamily()" class="w-full bg-indigo-600 text-white py-5 rounded-2xl font-black text-xl shadow-xl mt-4">Finish Setup ğŸ‰</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 3. MAIN APP -->
    <!-- Fix Bug 3: Safe padding top -->
    <div id="app-container" class="hidden max-w-md mx-auto p-4" style="padding-top: max(1rem, env(safe-area-inset-top));">
        <!-- HEADER -->
        <header class="mb-4">
            <div id="parent-tools" class="hidden flex justify-between items-center mb-4 bg-indigo-50 p-2 rounded-2xl border border-indigo-100">
                <select id="child-select" onchange="handleParentChildSwitch(this.value)" class="bg-transparent text-indigo-800 font-bold text-sm outline-none px-2 flex-1"></select>
                <button onclick="openModal('update-admin-modal')" class="bg-indigo-100 text-indigo-600 px-3 py-1.5 rounded-xl font-bold text-xs shadow-sm border border-indigo-200 mr-2">ğŸ”‘ PIN</button>
                <!-- Fix Bug 4: Call handleParentExit instead of logout -->
                <button onclick="handleParentExit()" class="bg-rose-100 text-rose-600 px-3 py-1.5 rounded-xl font-bold text-xs shadow-sm border border-rose-200">Exit</button>
            </div>
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div id="display-avatar" class="text-4xl w-12 h-12 flex items-center justify-center bg-white rounded-2xl shadow-sm">ğŸ‘¤</div>
                    <div><h1 id="display-name" class="text-lg font-black leading-none">...</h1><p id="display-family" class="text-[10px] text-slate-400 font-bold uppercase mt-1">...</p></div>
                </div>
                <div class="flex gap-2 items-center">
                    <button id="profile-edit-btn" onclick="openProfileEdit()" class="hidden bg-white text-indigo-600 px-3 py-2 rounded-xl font-bold text-xs shadow-sm border border-indigo-100">âš™ï¸</button>
                    <button id="admin-login-btn" onclick="openModal('admin-login-modal')" class="hidden bg-indigo-50 text-indigo-600 px-3 py-2 rounded-xl font-bold text-xs">Admin</button>
                    <button onclick="logout()" id="child-logout-btn" class="hidden bg-rose-50 text-rose-500 px-3 py-2 rounded-xl font-bold text-xs">ğŸšª</button>
                </div>
            </div>
        </header>

        <!-- TAB 1: WALLET -->
        <main id="tab-wallet" class="tab-content active">
            <div class="grid grid-cols-3 gap-2 mb-6">
                <div class="bg-indigo-500 p-3 rounded-2xl text-white text-center shadow-lg shadow-indigo-200"><div class="text-[9px] font-bold uppercase opacity-80">Spend</div><div id="bal-spend" class="text-lg font-black mt-1">$0</div></div>
                <div class="bg-amber-500 p-3 rounded-2xl text-white text-center shadow-lg shadow-amber-200"><div class="text-[9px] font-bold uppercase opacity-80">Save</div><div id="bal-save" class="text-lg font-black mt-1">$0</div></div>
                <div class="bg-rose-500 p-3 rounded-2xl text-white text-center shadow-lg shadow-rose-200"><div class="text-[9px] font-bold uppercase opacity-80">Share</div><div id="bal-share" class="text-lg font-black mt-1">$0</div></div>
            </div>

            <!-- Child Actions -->
            <div id="child-ui" class="hidden text-center">
                <div class="bg-white rounded-[2rem] p-6 shadow-xl border border-slate-100 mb-6 relative overflow-hidden">
                    <div class="absolute top-0 left-0 right-0 h-1 bg-gradient-to-r from-orange-400 via-pink-500 to-purple-500"></div>
                    <p class="text-[10px] text-slate-400 font-bold uppercase mb-2 tracking-widest">Weekly Allowance</p>
                    <button id="claim-btn" onclick="claimMoney()" class="w-full bg-gradient-to-r from-orange-400 via-pink-500 to-purple-500 text-white py-5 rounded-2xl text-lg font-black shadow-lg shadow-orange-200 mb-3 active:scale-95 transition-all animate-pulse">Grab Pocket Money! ğŸ</button>
                    <div class="flex justify-between px-4 mt-2">
                        <span id="claim-count" class="text-indigo-500 text-[10px] font-black uppercase tracking-widest">Streak: 0</span>
                        <span id="total-claimed" class="text-emerald-500 text-[10px] font-black uppercase tracking-widest">Earned: $0</span>
                    </div>
                </div>
                <button onclick="openModal('expense-modal')" class="w-full bg-white border border-slate-200 text-slate-700 py-4 rounded-2xl font-black mb-8 shadow-sm active:bg-slate-50">ğŸ’¸ Record Expense</button>
            </div>

            <!-- Parent UI -->
            <div id="parent-ui" class="hidden space-y-3 mb-6">
                <div class="bg-emerald-50 border border-emerald-100 rounded-[2rem] p-5 space-y-3">
                    <button onclick="openModal('reward-modal')" class="w-full bg-emerald-500 text-white py-3 rounded-xl font-bold shadow-md shadow-emerald-200">Give Reward ğŸŒŸ</button>
                    <button onclick="openModal('transfer-modal')" class="w-full bg-white text-emerald-600 border border-emerald-600 py-3 rounded-xl font-bold">Transfer / Move</button>
                    <button onclick="openModal('expense-modal')" class="w-full bg-slate-700 text-white py-3 rounded-xl font-bold">Deduct Money</button>
                </div>
            </div>

            <div class="flex justify-between items-center mb-3 px-1">
                <h3 class="font-bold text-slate-800 text-sm">Activity</h3>
                <div class="flex gap-1 bg-slate-100 p-1 rounded-xl">
                    <button onclick="filterHistory('week', this)" class="filter-btn active">Week</button>
                    <button onclick="filterHistory('month', this)" class="filter-btn">Month</button>
                </div>
            </div>
            <div id="history-list" class="scroll-area space-y-2 pb-24"></div>
        </main>

        <!-- TAB 2: GOALS -->
        <main id="tab-goals" class="tab-content pt-2">
            <div class="bg-white p-6 rounded-[2rem] border border-slate-100 shadow-sm mb-6 flex justify-between items-center">
                <div><div class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Total Saved</div><div id="goal-header-bal" class="text-4xl font-black text-amber-500">$0.00</div></div>
                <div class="text-right"><div class="text-[10px] font-bold text-slate-300 uppercase tracking-widest mb-1">Total Spent</div><div id="goal-header-spent" class="text-lg font-bold text-slate-400">$0.00</div></div>
            </div>
            <button onclick="openModal('goal-modal')" class="w-full bg-gradient-to-r from-indigo-500 to-purple-500 text-white py-4 rounded-2xl font-black shadow-lg mb-6 active:scale-95 transition-all">+ Add New Goal ğŸ¯</button>
            <div id="goals-list" class="space-y-4 pb-24"></div>
        </main>

        <!-- TAB 3: REPORT -->
        <main id="tab-review" class="tab-content pt-2">
            <h3 class="text-xl font-black text-slate-800 mb-4">Spending Report</h3>
            <div class="grid grid-cols-2 gap-3 mb-6"><div class="bg-white p-4 rounded-3xl border border-slate-100 text-center shadow-sm"><div class="text-[9px] font-black text-emerald-500 uppercase tracking-widest">Inflow</div><div id="dash-income" class="text-lg font-black text-emerald-600 mt-1">$0.00</div></div><div class="bg-white p-4 rounded-3xl border border-slate-100 text-center shadow-sm"><div class="text-[9px] font-black text-rose-500 uppercase tracking-widest">Outflow</div><div id="dash-expense" class="text-lg font-black text-rose-600 mt-1">$0.00</div></div></div>
            <div class="bg-white rounded-3xl p-6 border border-slate-100 shadow-sm mb-6 text-center relative">
                <h4 class="text-[9px] font-black text-slate-400 uppercase mb-4 tracking-widest">Satisfaction Score</h4>
                <div class="h-40 relative flex justify-center"><canvas id="reviewChart"></canvas><div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none"><span id="chart-percent" class="text-3xl font-black text-slate-700">0%</span><span class="text-[7px] font-bold text-slate-400 uppercase">Worth it</span></div></div>
                <div class="grid grid-cols-2 gap-4 mt-6 pt-4 border-t border-slate-100">
                    <div><div class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">Reviewed Count</div><div id="review-count-val" class="text-lg font-black text-slate-700">0</div></div>
                    <div><div class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">Reviewed Total</div><div id="review-amt-val" class="text-lg font-black text-slate-700">$0</div></div>
                </div>
            </div>
            <h3 class="font-bold text-slate-800 mb-3 px-1 text-sm">Review Expenses</h3><div id="review-list" class="space-y-3 pb-24"></div>
        </main>
    </div>

    <!-- Fix Bug 2: Bottom Nav visibility -->
    <nav id="bottom-nav" class="hidden fixed bottom-0 inset-x-0 bg-white/95 backdrop-blur-md border-t border-slate-100 flex justify-around p-2 z-50 pb-6" style="padding-bottom: max(1.5rem, env(safe-area-inset-bottom));">
        <button onclick="showTab('wallet')" id="nav-wallet" class="nav-btn active flex-1 flex flex-col items-center py-2"><span class="text-2xl mb-1">ğŸ‘›</span><span class="text-[9px] font-black uppercase">Wallet</span><div class="nav-indicator"></div></button>
        <button onclick="showTab('goals')" id="nav-goals" class="nav-btn flex-1 flex flex-col items-center py-2"><span class="text-2xl mb-1">ğŸ¯</span><span class="text-[9px] font-black uppercase">Goals</span><div class="nav-indicator"></div></button>
        <button onclick="showTab('review')" id="nav-review" class="nav-btn flex-1 flex flex-col items-center py-2"><span class="text-2xl mb-1">ğŸ“Š</span><span class="text-[9px] font-black uppercase">Report</span><div class="nav-indicator"></div></button>
    </nav>

    <!-- MODALS -->
    <!-- Expense Modal: Fix Bug 5 (Balances) -->
    <div id="expense-modal" class="modal">
        <div class="modal-box">
            <h2 class="text-xl font-black mb-4 text-slate-800 text-center">ğŸ’¸ Record Expense</h2>
            <input type="number" id="exp-amount" placeholder="0.00" class="w-full text-4xl font-black text-center border-b-2 border-slate-100 mb-6 outline-none py-2 text-slate-800">
            <p class="text-[10px] text-slate-400 font-bold uppercase mb-2">Category</p>
            <div class="grid grid-cols-5 gap-2 mb-4" id="cat-grid">
                <button onclick="selectCategory('Book', this)" class="cat-btn flex flex-col items-center p-2 rounded-xl" data-val="Book"><span class="text-2xl">ğŸ“š</span><span class="text-[9px] font-bold mt-1">Book</span></button>
                <button onclick="selectCategory('Candy', this)" class="cat-btn flex flex-col items-center p-2 rounded-xl" data-val="Candy"><span class="text-2xl">ğŸ¬</span><span class="text-[9px] font-bold mt-1">Candy</span></button>
                <button onclick="selectCategory('Snack', this)" class="cat-btn flex flex-col items-center p-2 rounded-xl" data-val="Snack"><span class="text-2xl">ğŸŸ</span><span class="text-[9px] font-bold mt-1">Snack</span></button>
                <button onclick="selectCategory('Toy', this)" class="cat-btn flex flex-col items-center p-2 rounded-xl" data-val="Toy"><span class="text-2xl">ğŸ§¸</span><span class="text-[9px] font-bold mt-1">Toy</span></button>
                <button onclick="selectCategory('Other', this)" class="cat-btn flex flex-col items-center p-2 rounded-xl" data-val="Other"><span class="text-2xl">â“</span><span class="text-[9px] font-bold mt-1">Other</span></button>
            </div>
            <input type="hidden" id="exp-category" value="Other">
            <p class="text-[10px] text-slate-400 font-bold uppercase mb-2">Expense Account</p>
            <div class="grid grid-cols-2 gap-3 mb-4" id="acc-selection-container">
                <button onclick="selectAccount('Spend Acc')" class="acc-btn w-full p-3 rounded-2xl flex flex-col items-center gap-1" data-val="Spend Acc">
                    <div class="check-icon">âœ…</div>
                    <div class="flex flex-row items-center justify-center gap-1"><span class="text-xl">ğŸ’¸</span><span class="text-[10px] font-black uppercase tracking-tight">Spend</span></div>
                    <span id="bal-hint-spend" class="text-[10px] font-bold text-slate-400 mt-0.5">$0</span>
                </button>
                <button onclick="selectAccount('Share Acc')" class="acc-btn w-full p-3 rounded-2xl flex flex-col items-center gap-1" data-val="Share Acc">
                    <div class="check-icon">âœ…</div>
                    <div class="flex flex-row items-center justify-center gap-1"><span class="text-xl">â¤ï¸</span><span class="text-[10px] font-black uppercase tracking-tight">Share</span></div>
                    <span id="bal-hint-share" class="text-[10px] font-bold text-slate-400 mt-0.5">$0</span>
                </button>
                <button onclick="selectAccount('Save Acc')" id="btn-save-acc" class="acc-btn w-full p-3 rounded-2xl flex flex-col items-center gap-1 col-span-2 hidden" data-val="Save Acc">
                    <div class="check-icon">âœ…</div>
                    <div class="flex flex-row items-center justify-center gap-1"><span class="text-xl">ğŸ·</span><span class="text-[10px] font-black uppercase tracking-tight">Save (Parent)</span></div>
                    <span id="bal-hint-save" class="text-[10px] font-bold text-slate-400 mt-0.5">$0</span>
                </button>
            </div>
            <input type="hidden" id="exp-account" value="">
            <input type="text" id="exp-desc" placeholder="What is it? (Required)" class="w-full p-4 bg-slate-50 rounded-2xl mb-6 outline-none font-bold transition-all border border-transparent focus:border-indigo-300">
            <button onclick="submitExpense()" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-black shadow-lg">Confirm</button>
            <button onclick="closeModal('expense-modal')" class="w-full mt-4 text-slate-400 font-bold">Cancel</button>
        </div>
    </div>
    
    <!-- Other Modals -->
    <div id="profile-modal" class="modal"><div class="modal-box"><h2 class="text-xl font-black mb-4 text-slate-800 text-center">Edit Profile</h2><div id="profile-edit-form"></div><button onclick="submitProfileEdit()" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-black mt-4 shadow-lg">Save Changes</button><button onclick="closeModal('profile-modal')" class="w-full mt-4 text-slate-400 font-bold">Cancel</button></div></div>
    <div id="update-admin-modal" class="modal"><div class="modal-box text-center"><h2 class="text-xl font-black mb-4 text-indigo-600">Change Admin PIN</h2><input type="text" id="new-admin-pin" placeholder="New PIN (e.g. P999)" class="w-full p-4 bg-slate-50 rounded-2xl mb-1 font-black text-center text-xl tracking-widest outline-none border border-slate-200 uppercase"><button onclick="submitUpdateParentPin()" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-black shadow-lg mt-4">Update PIN</button><button onclick="closeModal('update-admin-modal')" class="w-full mt-4 text-slate-400 font-bold">Cancel</button></div></div>
    <div id="delete-tx-modal" class="modal"><div class="modal-box text-center"><div class="text-6xl mb-4">ğŸ—‘ï¸</div><h2 class="text-xl font-black mb-2 text-slate-800">Delete & Refund?</h2><div class="flex gap-3"><button onclick="closeModal('delete-tx-modal')" class="flex-1 bg-slate-100 text-slate-400 py-3 rounded-2xl font-bold">Cancel</button><button id="del-confirm-btn" class="flex-1 bg-rose-500 text-white py-3 rounded-2xl font-black shadow-lg shadow-rose-200">Delete</button></div></div></div>
    <!-- Fix Bug 4: Child switching modal -->
    <div id="pick-child-modal" class="modal"><div class="modal-box text-center"><h2 class="text-xl font-black mb-6 text-indigo-600">Switch to Child</h2><div id="child-pick-grid" class="grid grid-cols-2 gap-4"></div><button onclick="closeModal('pick-child-modal')" class="w-full mt-6 text-slate-400 font-bold">Cancel</button></div></div>
    <div id="add-child-modal" class="modal"><div class="modal-box"><h2 class="text-xl font-black mb-4 text-emerald-600">Add New Child</h2><div id="new-child-form"></div><button onclick="submitAddChild()" class="w-full bg-emerald-500 text-white py-4 rounded-2xl font-black mt-4 shadow-lg">Create</button><button onclick="closeModal('add-child-modal')" class="w-full mt-4 text-slate-400 font-bold">Cancel</button></div></div>
    <div id="admin-login-modal" class="modal"><div class="modal-box text-center"><h2 class="text-xl font-black mb-6 text-indigo-600">Parent Access</h2><input type="text" id="admin-pin-input" placeholder="Enter Admin PIN" class="w-full p-4 bg-slate-50 rounded-2xl mb-6 font-black text-center text-xl tracking-widest outline-none border border-slate-200 uppercase"><button onclick="submitAdminLogin()" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-black shadow-lg">Verify</button><button onclick="closeModal('admin-login-modal')" class="w-full mt-4 text-slate-400 font-bold">Cancel</button></div></div>
    <div id="redeem-modal" class="modal"><div class="modal-box text-center"><div class="text-6xl mb-4">ğŸ</div><h2 class="text-xl font-black mb-2 text-slate-800">Redeem Goal?</h2><p id="redeem-msg" class="text-sm font-bold text-slate-500 mb-6"></p><div class="flex gap-3"><button onclick="closeModal('redeem-modal')" class="flex-1 bg-slate-100 text-slate-400 py-3 rounded-2xl font-bold">Cancel</button><button id="redeem-confirm-btn" class="flex-1 bg-emerald-500 text-white py-3 rounded-2xl font-black shadow-lg shadow-emerald-200">Yes, Buy It!</button></div></div></div>
    <div id="reward-modal" class="modal"><div class="modal-box"><h2 class="text-xl font-black mb-6 text-emerald-600 text-center">ğŸŒŸ Give Reward</h2><input type="number" id="rew-amount" placeholder="0.00" class="w-full text-4xl font-black text-center border-b-2 border-emerald-100 mb-6 outline-none py-2 text-emerald-600"><input type="text" id="rew-desc" placeholder="Reason (e.g. Chores)" class="w-full p-4 bg-slate-50 rounded-2xl mb-6 outline-none font-bold"><button onclick="submitReward()" class="w-full bg-emerald-500 text-white py-4 rounded-2xl font-black shadow-lg shadow-emerald-200">Send Money</button><button onclick="closeModal('reward-modal')" class="w-full mt-4 text-slate-400 font-bold">Cancel</button></div></div>
    <div id="transfer-modal" class="modal"><div class="modal-box"><h2 class="text-xl font-black mb-6 text-indigo-600 text-center">Move Money</h2><input type="number" id="trans-amount" placeholder="0.00" class="w-full text-4xl font-black text-center border-b-2 border-slate-100 mb-6 outline-none py-2"><div class="flex flex-col gap-2 mb-6"><select id="trans-from" class="p-3 bg-rose-50 rounded-xl font-bold text-rose-500 outline-none"><option value="Spend Acc">From Spend</option><option value="Save Acc">From Save</option><option value="Share Acc">From Share</option></select><div class="text-center text-slate-300">â¬‡</div><select id="trans-to" class="p-3 bg-emerald-50 rounded-xl font-bold text-emerald-500 outline-none"><option value="Spend Acc">To Spend</option><option value="Save Acc">To Save</option><option value="Share Acc">To Share</option></select></div><button onclick="submitTransfer()" class="w-full bg-slate-800 text-white py-4 rounded-2xl font-black shadow-lg">Execute</button><button onclick="closeModal('transfer-modal')" class="w-full mt-4 text-slate-400 font-bold">Cancel</button></div></div>
    <div id="goal-modal" class="modal"><div class="modal-box text-center"><h2 class="text-xl font-black mb-6 text-slate-800">New Goal ğŸ¯</h2><input type="text" id="goal-name" placeholder="Item Name" class="w-full p-4 bg-slate-100 rounded-2xl mb-3 font-bold text-center outline-none"><input type="number" id="goal-target" placeholder="Price ($)" class="w-full p-4 bg-slate-100 rounded-2xl mb-6 font-bold text-center outline-none"><button onclick="submitGoal()" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-black shadow-lg">Save Goal</button><button onclick="closeModal('goal-modal')" class="w-full mt-4 text-slate-400 font-bold">Cancel</button></div></div>

    <script>
        // âš ï¸âš ï¸âš ï¸ è¯·åŠ¡å¿…åœ¨æ­¤å¤„å¡«å…¥ä½ çš„ GAS Web App URL âš ï¸âš ï¸âš ï¸
        const API_URL = "https://script.google.com/macros/s/AKfycbyThRRgNAHPH4929SuZNSczs3E5Jao8Z93Y0yreLZsTWq8K_1PtXThKdHOzqfaCBtXH/exec"; 

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./service-worker.js')
            .then(() => console.log('SW Registered'))
            .catch(err => console.error('SW Fail', err));
        }

        let state = { fid: null, cid: null, role: null, children: [], transactions: [], goals: [], balances: {spend:0,save:0,share:0}, currentChildObj: {} };
        let myChart = null;

        function toast(msg, type='success') { const div = document.createElement('div'); div.className = `toast ${type}`; div.innerText = msg; document.getElementById('toast-container').appendChild(div); setTimeout(() => div.remove(), 3000); }
        
        async function api(action, payload) {
            const response = await fetch(API_URL, {
                method: "POST",
                body: JSON.stringify({ ...payload, action, familyId: state.fid, childId: state.cid, identity: state.role })
            });
            const data = await response.json();
            if (!data.success) throw new Error(data.error);
            return data;
        }

        function init() {
            const cached = localStorage.getItem('pb_cache');
            if (cached) {
                try {
                    const d = JSON.parse(cached);
                    console.log("Loading from Cache âš¡");
                    state.fid = d.fid; state.cid = d.cid; state.role = d.role;
                    renderDash(d.data);
                    document.getElementById('global-loader').classList.add('hidden');
                    fetchDash(false);
                } catch(e) {
                    localStorage.removeItem('pb_cache');
                    showAuth();
                }
            } else {
                showAuth();
            }
        }

        function showAuth() { document.getElementById('global-loader').classList.add('hidden'); document.getElementById('auth-screen').classList.remove('hidden'); }
        
        function closeModal(id) { document.getElementById(id).classList.remove('open'); }
        function openModal(id) { 
            const el = document.getElementById(id); if(el) el.classList.add('open'); 
            if(id === 'expense-modal') {
                const btn = document.querySelector('[data-val="Other"]'); if(btn) selectCategory('Other', btn);
                if(document.getElementById('exp-account')) document.getElementById('exp-account').value = ""; 
                document.querySelectorAll('.acc-btn').forEach(b => b.classList.remove('selected'));
                // Fix Bug 5: Update balance hints immediately
                const bal = state.balances;
                document.getElementById('bal-hint-spend').innerText = '$' + (bal.spend||0).toFixed(2);
                document.getElementById('bal-hint-share').innerText = '$' + (bal.share||0).toFixed(2);
                document.getElementById('bal-hint-save').innerText = '$' + (bal.save||0).toFixed(2);
            }
        }
        function showTab(tab) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
            const t = document.getElementById('tab-' + tab); const n = document.getElementById('nav-' + tab);
            if(t) t.classList.add('active'); if(n) n.classList.add('active');
        }
        
        async function fetchDash(showLoader=false) {
            if(showLoader) document.body.classList.add('loading');
            try {
                const d = await api('loadDashboard', {});
                renderDash(d);
                localStorage.setItem('pb_cache', JSON.stringify({ fid:state.fid, cid:state.cid, role:state.role, data: d }));
            } catch(e) {
                console.error("Sync failed", e);
            } finally {
                if(showLoader) document.body.classList.remove('loading');
            }
        }

        function renderDash(d) {
            if(!d) return;
            state.children = d.children || [];
            if(state.cid !== d.activeChildId && d.activeChildId) state.cid = d.activeChildId;
            const isParent = state.role === 'Parent';
            const c = d.currentChild || {};
            state.currentChildObj = c;
            const bal = c.balances || {spend:0, save:0, share:0};
            state.balances = bal;
            state.transactions = d.transactions || [];
            
            // UI Toggles
            const setCls = (id, action, cls) => { const el = document.getElementById(id); if(el) { if(action==='add') el.classList.add(cls); if(action==='remove') el.classList.remove(cls); } };
            setCls('child-ui', isParent ? 'add' : 'remove', 'hidden');
            setCls('parent-ui', !isParent ? 'add' : 'remove', 'hidden');
            setCls('parent-tools', !isParent ? 'add' : 'remove', 'hidden');
            setCls('admin-login-btn', isParent ? 'add' : 'remove', 'hidden');
            setCls('profile-edit-btn', !isParent ? 'add' : 'remove', 'hidden');
            setCls('child-logout-btn', isParent ? 'add' : 'remove', 'hidden');
            setCls('btn-save-acc', isParent ? 'remove' : 'add', 'hidden');

            document.getElementById('app-container').classList.remove('hidden');
            document.getElementById('auth-screen').classList.add('hidden');
            
            // Fix Bug 2: Ensure Nav is Visible
            document.getElementById('bottom-nav').classList.remove('hidden');

            document.getElementById('display-avatar').innerText = c.avatar || 'ğŸ‘¤';
            document.getElementById('display-name').innerText = isParent ? `Admin: ${c.name}` : c.name;
            document.getElementById('display-family').innerText = d.familyName || 'Family';

            document.getElementById('bal-spend').innerText = '$'+(bal.spend||0).toFixed(2);
            document.getElementById('bal-save').innerText = '$'+(bal.save||0).toFixed(2);
            document.getElementById('bal-share').innerText = '$'+(bal.share||0).toFixed(2);
            document.getElementById('goal-header-bal').innerText = '$'+(bal.save||0).toFixed(2);
            document.getElementById('goal-header-spent').innerText = '$'+((d.stats||{}).totalRedeemed || 0).toFixed(2);

            const abtn = document.getElementById('claim-btn');
            const allowStatus = d.allowanceStatus || { alreadyClaimed: false };
            if(abtn) {
                if(allowStatus.alreadyClaimed) { 
                    abtn.disabled = true; abtn.classList.add('disabled-claim'); abtn.classList.remove('animate-pulse'); abtn.innerText = "See you next week! ğŸ‘‹"; 
                } else { 
                    abtn.disabled = false; abtn.classList.remove('disabled-claim'); abtn.classList.add('animate-pulse'); abtn.innerText = `Grab $${c.weeklyAmt || 0}! ğŸ`; 
                }
            }
            document.getElementById('claim-count').innerText = `Streak: ${allowStatus.streak || 0} Wks`;
            document.getElementById('total-claimed').innerText = `Earned: $${(d.stats?.lifetimeAllowance || 0).toFixed(0)}`;

            renderHistory();

            const elGoals = document.getElementById('goals-list');
            if(elGoals) {
                elGoals.innerHTML = (d.goals||[]).map(g => {
                    const t = parseFloat(g.target) || 1; 
                    const currentSave = bal.save || 0;
                    const redeemed = g.status === 'Redeemed'; 
                    const prog = redeemed ? 100 : Math.min(Math.floor((currentSave / t)*100), 100); 
                    const canBuy = currentSave >= t && !redeemed;
                    return `<div class="bg-white p-5 rounded-3xl shadow-sm border ${redeemed?'border-transparent bg-slate-50 grayscale':'border-slate-100'}"><div class="flex justify-between mb-2"><span class="font-bold text-slate-800">${redeemed?'âœ… ':''}${g.name}</span><span class="text-sm font-bold text-indigo-600">$${t}</span></div><div class="w-full bg-slate-100 h-4 rounded-full mb-2 overflow-hidden relative"><div class="h-full transition-all duration-1000 ${redeemed?'bg-emerald-400':'bg-indigo-500'}" style="width: ${prog}%"></div><span class="absolute inset-0 flex items-center justify-center text-[9px] font-black text-white drop-shadow-md">${prog}%</span></div><div class="flex justify-between items-center"><span class="text-[10px] font-bold ${canBuy?'text-emerald-500':'text-slate-400'} uppercase">${redeemed?'Completed':(canBuy?'Ready to buy!':`Need $${(t-currentSave).toFixed(2)}`)}</span>${canBuy && isParent ? `<button onclick="openRedeemModal('${g.id}', ${t}, '${g.name}')" class="bg-emerald-500 text-white text-[9px] px-3 py-1 rounded-full font-bold shadow-md">Redeem</button>`:''}</div></div>`;
                }).join('');
            }

            const st = d.stats || { income:0, expense:0, worth:0, waste:0 };
            document.getElementById('dash-income').innerText = `$${st.income.toFixed(2)}`;
            document.getElementById('dash-expense').innerText = `$${st.expense.toFixed(2)}`;
            document.getElementById('review-count-val').innerText = d.reviewedStats.count;
            document.getElementById('review-amt-val').innerText = '$' + d.reviewedStats.total.toFixed(2);
            
            const pct = (st.worth + st.waste) > 0 ? Math.round((st.worth/(st.worth+st.waste))*100) : 0;
            document.getElementById('chart-percent').innerText = pct + "%";
            
            const cEl = document.getElementById('reviewChart');
            if(cEl) {
                const ctx = cEl.getContext('2d');
                if(myChart) myChart.destroy();
                myChart = new Chart(ctx, { type: 'doughnut', data: { labels: ['Worth','Waste'], datasets: [{ data: [st.worth||1, st.waste||(st.worth?0:1)], backgroundColor: ['#10b981','#f43f5e'], borderWidth: 0 }] }, options: { cutout: '78%', plugins: { legend: { display: false } } } });
            }
            
            const unreviewed = state.transactions.filter(x => x.type.toLowerCase() === 'expense' && !x.review && parseFloat(x.amount) < 0);
            const revList = document.getElementById('review-list');
            if(revList) {
                revList.innerHTML = unreviewed.length ? unreviewed.map(t => `<div class="bg-white p-4 rounded-2xl flex justify-between items-center shadow-sm border border-slate-50"><div><div class="font-bold text-sm text-slate-800">${t.desc}</div><div class="text-[10px] text-rose-500 font-bold">$${Math.abs(t.amount).toFixed(2)}</div></div><div class="flex gap-2"><button onclick="doReview('${t.id}', 'ğŸ‘')" class="p-2 bg-emerald-50 rounded-xl text-lg">ğŸ‘</button><button onclick="doReview('${t.id}', 'ğŸ‘')" class="p-2 bg-rose-50 rounded-xl text-lg">ğŸ‘</button></div></div>`).join('') : `<div class="text-center py-8"><div class="text-4xl mb-2">âœ¨</div><div class="text-slate-300 text-xs font-bold uppercase tracking-widest">All Clean!</div></div>`;
            }

            if(isParent) {
                 const sel = document.getElementById('child-select');
                 const opts = (d.children||[]).map(k => `<option value="${k.id}" ${k.id === state.cid ? 'selected' : ''}>Manage: ${k.name}</option>`);
                 opts.push(`<option value="ADD_NEW">â• Add New Child</option>`);
                 sel.innerHTML = opts.join('');
                 sel.value = state.cid;
            }
        }

        let currentFilter = 'week';
        function filterHistory(period, btn) { currentFilter = period; document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active')); if(btn) btn.classList.add('active'); renderHistory(); }
        function renderHistory() {
            const now = new Date();
            const filtered = state.transactions.filter(t => {
                const date = new Date(t.date);
                if (currentFilter === 'week') { const d = new Date(); d.setDate(now.getDate() - 7); return date >= d; }
                else if (currentFilter === 'month') { const d = new Date(); d.setDate(now.getDate() - 30); return date >= d; }
                return true;
            });
            const isParent = state.role === 'Parent';
            document.getElementById('history-list').innerHTML = filtered.map(t => {
                const dObj = new Date(t.date);
                const tStr = dObj.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                const iconMap = {'Book':'ğŸ“š', 'Candy':'ğŸ¬', 'Snack':'ğŸŸ', 'Toy':'ğŸ§¸', 'Other':'â“', 'General':'ğŸ’¸', 'Allowance':'ğŸ’°', 'Reward':'ğŸŒŸ'};
                const icon = iconMap[t.category] || 'ğŸ’¸';
                return `<div class="bg-white p-4 rounded-2xl flex justify-between items-center border border-slate-50 shadow-sm"><div class="flex items-center gap-3 overflow-hidden"><div class="text-xl">${icon}</div><div class="flex-1 overflow-hidden"><div class="font-bold text-slate-800 text-sm truncate">${t.desc}</div><div class="text-[9px] text-slate-400 font-bold uppercase tracking-widest">${t.account} â€¢ ${dObj.toLocaleDateString()} ${tStr}</div></div></div><div class="flex items-center gap-3"><div class="font-black ${parseFloat(t.amount)<0?'text-rose-500':'text-emerald-500'} text-sm">${parseFloat(t.amount)<0?'':'+'}${parseFloat(t.amount).toFixed(2)}</div>${isParent ? `<button onclick="openDeleteModal('${t.id}')" class="text-red-500 text-lg hover:scale-110 transition-transform">ğŸ—‘</button>` : ''}</div></div>`;
            }).join('');
        }

        async function handleLogin() {
            const code = document.getElementById('login-code').value.trim();
            const email = document.getElementById('login-email').value.trim();
            if(!code || !email) return toast('Enter PIN & Email', 'error');
            const btn = document.getElementById('login-btn');
            btn.disabled = true; btn.innerText = "Verifying...";
            try {
                const res = await api('login', {code, email});
                state.fid = res.familyId; state.cid = res.childId; state.role = res.role;
                await fetchDash(true);
            } catch(e) {
                toast(e.message, 'error');
                btn.disabled = false; btn.innerText = "Unlock";
            }
        }

        async function claimMoney() {
            const btn = document.getElementById('claim-btn');
            btn.disabled = true; btn.innerText = "Claimed! ğŸš€"; btn.classList.add('disabled-claim');
            const amt = parseFloat(state.currentChildObj.weeklyAmt || 0);
            const r = state.currentChildObj.ratios || {spend:50,save:30,share:20};
            state.balances.spend += amt * (r.spend/100); state.balances.save += amt * (r.save/100); state.balances.share += amt * (r.share/100);
            document.getElementById('bal-spend').innerText = '$'+state.balances.spend.toFixed(2);
            confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
            try { await api('claimAllowance', {}); fetchDash(false); } catch(e) { toast(e.message, 'error'); fetchDash(false); }
        }

        async function submitExpense(){ 
            const a=parseFloat(document.getElementById('exp-amount').value), d=document.getElementById('exp-desc').value, ac=document.getElementById('exp-account').value, cat=document.getElementById('exp-category').value;
            if(!a || !ac) return toast('Amount & Account required','error');
            closeModal('expense-modal');
            const k = ac.split(' ')[0].toLowerCase();
            state.balances[k] -= a; document.getElementById(`bal-${k}`).innerText = '$'+state.balances[k].toFixed(2);
            state.transactions.unshift({desc: d||cat, amount: -a, account: ac, category: cat, date: new Date().toISOString()}); renderHistory();
            try{await api('addExpense',{amount:a, description:d||cat, account:ac, category: cat}); fetchDash(false);} catch(e){toast(e.message,'error'); fetchDash(false);} 
        }

        async function sendOTP() { const email = document.getElementById('reg-email').value; if(!email) return toast('Invalid Email', 'error'); const btn = document.getElementById('otp-btn'); btn.disabled = true; btn.innerText = "..."; try { await api('sendOTP', {email}, false); toast('Sent!'); let c=60; const t=setInterval(()=>{ c--; btn.innerText=`${c}s`; if(c<=0){clearInterval(t);btn.disabled=false;btn.innerText="Get Code";} },1000); } catch(e) { toast(e.message,'error'); btn.disabled=false; btn.innerText="Get Code"; } }
        async function verifyOTP(){ try{ const r=await api('verifyOTP',{email:document.getElementById('reg-email').value, otp:document.getElementById('reg-otp').value}); document.getElementById('reg-parent-pin').value=r.suggestedPin; document.getElementById('step-1').classList.add('hidden'); document.getElementById('step-2').classList.remove('hidden'); if(document.getElementById('children-list').innerHTML==='') addChildRow('children-list'); }catch(e){toast(e.message,'error');} }
        
        // Fix Bug 6: Improved Child Row with Split Controls
        function addChildRow(containerId) { 
            const container = document.getElementById(containerId); 
            const div = document.createElement('div'); 
            div.className = "child-row bg-slate-50 p-5 rounded-[2rem] border border-slate-200 relative mb-4"; 
            const randCode = 'K' + Math.floor(Math.random()*900 + 100); 
            const rowId = 'child-' + Date.now(); 
            div.setAttribute('id', rowId);
            div.innerHTML = `
                <div class="flex justify-between items-center mb-3"><span class="text-xs font-bold text-indigo-500 uppercase tracking-widest">Child Profile</span><button onclick="this.closest('.child-row').remove()" class="text-rose-400 font-bold text-xs bg-rose-50 px-2 py-1 rounded-lg">Remove</button></div>
                <div class="flex gap-4 justify-center mb-4"><input type="hidden" class="c-avatar" value="ğŸ‘¦"><button onclick="selectAvatar(this, 'ğŸ‘¦')" class="avatar-btn selected">ğŸ‘¦</button><button onclick="selectAvatar(this, 'ğŸ‘§')" class="avatar-btn">ğŸ‘§</button><button onclick="selectAvatar(this, 'ğŸ§‘â€ğŸš€')" class="avatar-btn">ğŸ§‘â€ğŸš€</button><button onclick="selectAvatar(this, 'ğŸ¦„')" class="avatar-btn">ğŸ¦„</button></div>
                <div class="space-y-3">
                    <div><label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Name</label><input class="c-name w-full p-3 bg-white rounded-xl font-bold text-sm outline-none border border-slate-100" placeholder="e.g. Alex"></div>
                    <div class="flex gap-3"><div class="flex-1"><label class="text-[10px] font-bold text-slate-400 uppercase ml-1">PIN</label><input class="c-code w-full p-3 bg-white rounded-xl font-black text-center uppercase text-indigo-600 border border-slate-100 outline-none" value="${randCode}"></div><div class="w-24"><label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Weekly $</label><input class="c-amt w-full p-3 bg-white rounded-xl font-bold text-center border border-slate-100 outline-none" type="number" value="10"></div></div>
                </div>
                <div class="bg-indigo-50/50 p-3 rounded-xl border border-indigo-100 mt-3">
                    <div class="flex justify-between items-center mb-2"><span class="text-[9px] font-bold text-slate-400 uppercase">Jars Split</span><span class="ratio-total text-[9px] font-black text-emerald-500">Total: 100%</span></div>
                    <div class="flex gap-2">
                        ${renderRatioInput(rowId, 'spend', 'Spend', 50, 'text-indigo-600')}
                        ${renderRatioInput(rowId, 'save', 'Save', 30, 'text-amber-600')}
                        ${renderRatioInput(rowId, 'share', 'Share', 20, 'text-rose-600')}
                    </div>
                </div>`; 
            container.appendChild(div); 
        }

        function renderRatioInput(rowId, type, label, val, colorClass) { 
            return `<div class="flex-1 flex flex-col items-center"><span class="text-[8px] font-bold uppercase mb-1 opacity-60">${label}</span><div class="flex items-center bg-white rounded-lg p-1 w-full shadow-sm"><button onclick="adjustRatioVal('${rowId}', '${type}', -5)" class="w-6 h-6 text-slate-400 font-bold hover:text-slate-600">-</button><input type="number" class="c-r-${type} w-full text-center text-xs font-bold border-none outline-none ${colorClass}" value="${val}" oninput="updateRatioTotal('${rowId}')"><button onclick="adjustRatioVal('${rowId}', '${type}', 5)" class="w-6 h-6 text-slate-400 font-bold hover:text-slate-600">+</button></div></div>`; 
        }
        function adjustRatioVal(rowId, type, change) { const row = document.getElementById(rowId); const input = row.querySelector(`.c-r-${type}`); let val = parseInt(input.value) || 0; val = Math.max(0, Math.min(100, val + change)); input.value = val; updateRatioTotal(rowId); }
        function updateRatioTotal(rowId) { const row = document.getElementById(rowId); const s = parseInt(row.querySelector('.c-r-spend').value)||0; const v = parseInt(row.querySelector('.c-r-save').value)||0; const h = parseInt(row.querySelector('.c-r-share').value)||0; const total = s + v + h; const label = row.querySelector('.ratio-total'); label.innerText = `Total: ${total}%`; if (total !== 100) { label.classList.remove('text-emerald-500'); label.classList.add('ratio-err'); } else { label.classList.remove('ratio-err'); label.classList.add('text-emerald-500'); } }
        
        function selectAvatar(btn, emoji) { const row = btn.closest('.child-row'); row.querySelectorAll('.avatar-btn').forEach(b => b.classList.remove('selected')); btn.classList.add('selected'); row.querySelector('.c-avatar').value = emoji; }
        
        async function registerFamily() { 
            // Fix Bug 1: Ensure DOM is ready and IDs match
            const name = document.getElementById('reg-family-name').value;
            if(!name) return toast('Family name required', 'error');
            const rows = document.querySelectorAll('.child-row'); 
            const kids = Array.from(rows).map(r=>({ name: r.querySelector('.c-name').value, avatar: r.querySelector('.c-avatar').value, code: r.querySelector('.c-code').value, weeklyAmt: r.querySelector('.c-amt').value, ratios:{spend:parseInt(r.querySelector('.c-r-spend').value), save:parseInt(r.querySelector('.c-r-save').value), share:parseInt(r.querySelector('.c-r-share').value)}})); 
            try{ const r=await api('createFamily',{familyName:name, contactEmail:document.getElementById('reg-email').value, parentPin:document.getElementById('reg-parent-pin').value, children:kids}); toast('Success!'); state={fid:r.familyId, cid:r.childId, role:'Parent'}; await fetchDash(true); }catch(e){toast(e.message,'error');} 
        }
        
        function selectCategory(c,b) { document.getElementById('exp-category').value=c; document.querySelectorAll('.cat-btn').forEach(x=>x.classList.remove('selected')); b.classList.add('selected'); }
        function selectAccount(a) { document.getElementById('exp-account').value=a; document.querySelectorAll('.acc-btn').forEach(x=>x.classList.remove('selected')); document.querySelector(`[data-val="${a}"]`).classList.add('selected'); }
        function logout() { localStorage.removeItem('pb_cache'); location.reload(); }
        function handleParentChildSwitch(val) { if (val === 'ADD_NEW') { document.getElementById('new-child-form').innerHTML = ''; addChildRow('new-child-form'); openModal('add-child-modal'); document.getElementById('child-select').value = state.cid; } else { state.cid = val; fetchDash(true); } }
        async function submitAddChild() { const form = document.getElementById('new-child-form').querySelector('.child-row'); const data = { name: form.querySelector('.c-name').value, avatar: form.querySelector('.c-avatar').value, code: form.querySelector('.c-code').value, weeklyAmt: form.querySelector('.c-amt').value, ratios: { spend: parseInt(form.querySelector('.c-r-spend').value), save: parseInt(form.querySelector('.c-r-save').value), share: parseInt(form.querySelector('.c-r-share').value) } }; closeModal('add-child-modal'); try { const res = await api('addChild', data); toast('Added!'); state.cid = res.newChildId; fetchDash(true); } catch(e) { toast(e.message, 'error'); } }
        
        function openProfileEdit() { 
            const child = state.children.find(c => c.id === state.cid); 
            const container = document.getElementById('profile-edit-form'); 
            container.innerHTML = ''; 
            addChildRow('profile-edit-form'); 
            const row = container.querySelector('.child-row'); 
            // Pre-fill
            row.querySelector('.c-name').value = child.name; 
            row.querySelector('.c-code').value = child.code; 
            row.querySelector('.c-amt').value = child.weeklyAmt; 
            row.querySelector('.c-r-spend').value = child.ratios.spend; 
            row.querySelector('.c-r-save').value = child.ratios.save; 
            row.querySelector('.c-r-share').value = child.ratios.share; 
            // Fix: remove delete button for edit profile
            row.querySelector('button.text-rose-400').style.display = 'none';
            selectAvatar(row.querySelectorAll('.avatar-btn')[['ğŸ‘¦','ğŸ‘§','ğŸ§‘â€ğŸš€','ğŸ¦„'].indexOf(child.avatar)||0], child.avatar); 
            openModal('profile-modal'); 
            // Re-calc totals for visual
            updateRatioTotal(row.id);
        }
        
        async function submitProfileEdit() { const form = document.getElementById('profile-edit-form').querySelector('.child-row'); const data = { childId: state.cid, name: form.querySelector('.c-name').value, avatar: form.querySelector('.c-avatar').value, code: form.querySelector('.c-code').value, weeklyAmt: form.querySelector('.c-amt').value, ratios: { spend: parseInt(form.querySelector('.c-r-spend').value), save: parseInt(form.querySelector('.c-r-save').value), share: parseInt(form.querySelector('.c-r-share').value) } }; closeModal('profile-modal'); try { await api('updateChildProfile', data); toast('Updated'); fetchDash(true); } catch(e) { toast(e.message, 'error'); } }
        async function submitReward(){ const a=document.getElementById('rew-amount').value,d=document.getElementById('rew-desc').value; closeModal('reward-modal'); try{await api('addReward',{amount:a,description:d});toast('Sent');fetchDash(false);}catch(e){toast(e.message,'error');} }
        async function submitTransfer(){ const a=document.getElementById('trans-amount').value,f=document.getElementById('trans-from').value,t=document.getElementById('trans-to').value; closeModal('transfer-modal'); try{await api('transfer',{amount:a,from:f,to:t});toast('Done');fetchDash(false);}catch(e){toast(e.message,'error');} }
        async function submitGoal(){ const n=document.getElementById('goal-name').value,t=document.getElementById('goal-target').value; closeModal('goal-modal'); try{await api('addGoal',{name:n,target:t});toast('Saved');fetchDash(false);}catch(e){toast(e.message,'error');} }
        function openRedeemModal(id, amt, name) { document.getElementById('redeem-msg').innerText = `Use $${amt} from Save Jar to buy "${name}"?`; document.getElementById('redeem-confirm-btn').onclick = () => confirmRedeem(id, amt, name); openModal('redeem-modal'); }
        async function confirmRedeem(id, amt, name) { closeModal('redeem-modal'); try { await api('redeemGoal', {id, amount:amt, name}); toast('Redeemed!'); fetchDash(false); } catch(e) { toast(e.message, 'error'); } }
        async function doReview(id,v){ try{await api('updateReview',{id,review:v});toast('Saved');fetchDash(false);}catch(e){toast(e.message,'error');} }
        async function submitUpdateParentPin() { try { await api('updateParentPin', { newPin: document.getElementById('new-admin-pin').value }); toast('Updated!'); closeModal('update-admin-modal'); } catch(e) { toast(e.message, 'error'); } }
        async function submitAdminLogin() { try { await api('verifyParentPin', { pin: document.getElementById('admin-pin-input').value }); closeModal('admin-login-modal'); state.role='Parent'; fetchDash(true); } catch(e) { toast(e.message, 'error'); } }
        function openDeleteModal(txId) { document.getElementById('del-confirm-btn').onclick = () => confirmDelete(txId); openModal('delete-tx-modal'); }
        async function confirmDelete(txId) { closeModal('delete-tx-modal'); try { await api('deleteTransaction', {txId}); toast('Deleted'); fetchDash(false); } catch(e){ toast(e.message,'error'); } }
        function goToSignup() { document.getElementById('auth-screen').classList.add('hidden'); document.getElementById('signup-screen').classList.remove('hidden'); }
        function goToAuth() { document.getElementById('signup-screen').classList.add('hidden'); document.getElementById('auth-screen').classList.remove('hidden'); }

        // Fix Bug 4: Proper Parent Exit Logic
        function handleParentExit() {
            if (state.children && state.children.length > 0) {
                // Show picker to switch to a child
                const grid = document.getElementById('child-pick-grid');
                grid.innerHTML = state.children.map(c => 
                    `<button onclick="switchChild('${c.id}')" class="bg-slate-50 border border-slate-200 p-4 rounded-2xl flex flex-col items-center active:scale-95 transition-transform">
                        <span class="text-3xl mb-2">${c.avatar}</span>
                        <span class="font-bold text-slate-700 text-xs">${c.name}</span>
                    </button>`
                ).join('');
                openModal('pick-child-modal');
            } else {
                logout();
            }
        }

        function switchChild(id) { 
            state.cid = id; 
            state.role = 'Child'; 
            closeModal('pick-child-modal'); 
            fetchDash(true); 
        }

        init();
    </script>
</body>
</html>
