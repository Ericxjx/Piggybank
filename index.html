<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>PiggyBank</title>
    <link rel="manifest" href="./manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Fredoka', sans-serif; background-color: #f8fafc; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; padding-top: env(safe-area-inset-top); user-select: none; }
        
        #global-loader { position: fixed; inset: 0; background: #fff; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s; }
        #global-loader.fade-out { opacity: 0; pointer-events: none; }

        body.dark-mode { background-color: #0f172a; color: #cbd5e1; }
        body.dark-mode .bg-white { background-color: #1e293b; color: #fff; }
        body.dark-mode .modal-box { background-color: #1e293b; color: white; }

        .tab-content { display: none; height: 100%; overflow-y: auto; padding-bottom: 110px; padding-left:16px; padding-right:16px; }
        .tab-content.active { display: block; animation: fadeIn 0.3s forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Cards */
        .cards-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px; }
        .dashboard-card { border-radius: 20px; padding: 16px; height: 160px; display: flex; flex-direction: column; justify-content: space-between; position: relative; overflow: hidden; transition: transform 0.2s; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .dashboard-card:active { transform: scale(0.98); }
        .card-credit { background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; }
        .card-credit.overdue { background: linear-gradient(135deg, #ef4444, #b91c1c); animation: pulseRed 2s infinite; }
        .card-save { background: white; border: 1px solid #e2e8f0; color: #334155; }
        body.dark-mode .card-save { background: #1e293b; border-color: #334155; color: white; }
        @keyframes pulseRed { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }

        /* Pending Item (Dynamic Button) */
        .claim-btn-lg { width: 100%; padding: 20px; border-radius: 24px; background: linear-gradient(to right, #fbbf24, #f59e0b); color: white; font-weight: 900; font-size: 18px; box-shadow: 0 10px 25px -5px rgba(245, 158, 11, 0.5); animation: popIn 0.5s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .claim-btn-sm { font-size: 12px; padding: 10px; background: #f1f5f9; color: #94a3b8; border-radius: 12px; font-weight: bold; pointer-events: none; text-align: center; }
        @keyframes popIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* Floating Nav (The Island) - Fixed Layout */
        #bottom-nav { 
            position: fixed; 
            bottom: 20px; 
            left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 32px);
            max-width: 440px;
            height: 54px;
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(25px) saturate(200%);
            -webkit-backdrop-filter: blur(25px) saturate(200%);
            border-radius: 27px;
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.12), inset 0 1px 0 rgba(255, 255, 255, 0.8);
            z-index: 50;
            display: flex;
            align-items: center; 
            justify-content: space-evenly;
            padding: 0 10px;
        }
        #bottom-nav.hidden { display: none !important; }
        body.dark-mode #bottom-nav { background: rgba(30, 41, 59, 0.8); border-color: rgba(255,255,255,0.1); }

        .nav-btn { color: #94a3b8; transition: all 0.3s; flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; }
        .nav-btn.active { color: #4f46e5; transform: translateY(-2px); }
        .nav-indicator { height: 5px; width: 5px; background: #4f46e5; border-radius: 50%; margin-top: 2px; opacity: 0; transform: scale(0); transition: all 0.3s; }
        .nav-btn.active .nav-indicator { opacity: 1; transform: scale(1); }

        /* FAB - Left Bottom */
        .fab-container { position: fixed; bottom: 100px; left: 24px; z-index: 50; display: flex; flex-direction: column-reverse; align-items: center; gap: 12px; }
        .fab-main { width: 56px; height: 56px; border-radius: 28px; background: #334155; color: white; font-size: 28px; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2); transition: transform 0.2s; }
        .fab-menu { display: none; flex-direction: column-reverse; gap: 12px; align-items: center; padding-bottom: 5px; }
        .fab-menu.open { display: flex; animation: slideUp 0.2s; }
        .fab-item { display: flex; align-items: center; gap: 10px; }
        .fab-label { background: white; padding: 4px 10px; border-radius: 8px; font-size: 11px; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.1); color: #475569; }
        .fab-btn { width: 44px; height: 44px; border-radius: 22px; display: flex; align-items: center; justify-content: center; font-size: 18px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); color: white; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Header Dropdown */
        #child-switcher-container { position: relative; }
        #child-dropdown { display: none; position: absolute; top: 100%; left: 0; background: white; border-radius: 16px; padding: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); z-index: 60; min-width: 160px; margin-top: 8px; }
        body.dark-mode #child-dropdown { background: #1e293b; border: 1px solid #334155; }
        #child-dropdown.open { display: block; animation: fadeIn 0.2s; }

        /* Notif */
        .notif-toast { position: fixed; top: 120px; left: 50%; transform: translateX(-50%); background: #fff; padding: 12px 20px; border-radius: 99px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); z-index: 100; font-weight: bold; display: flex; gap: 10px; align-items: center; width: 90%; max-width: 350px; animation: slideDown 0.3s; pointer-events: none; }
        @keyframes slideDown { from { transform: translate(-50%, -20px); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }

        .modal { display: none; position: fixed; inset: 0; z-index: 70; align-items: center; justify-content: center; backdrop-filter: blur(4px); background-color: rgba(0,0,0,0.5); }
        .modal.open { display: flex; }
        .modal-box { width: 90%; max-width: 22rem; background: white; border-radius: 2rem; padding: 1.5rem; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); max-height: 80vh; overflow-y: auto; }
    </style>
</head>
<body>
    <div id="global-loader"><div class="text-6xl animate-bounce mb-4">üê∑</div><div class="font-bold text-slate-400">Loading...</div></div>
    <div id="toast-container"></div>

    <!-- 1. AUTH SCREEN -->
    <div id="auth-screen" class="fixed inset-0 z-50 bg-slate-50 flex flex-col items-center justify-center p-6 hidden">
        <div class="text-6xl mb-6">üê∑</div>
        <h1 class="text-3xl font-black text-indigo-600 mb-8">PiggyBank</h1>
        <div id="login-form" class="w-full max-w-sm bg-white p-8 rounded-[2rem] shadow-xl text-center">
            <h2 class="font-bold text-slate-400 uppercase text-xs mb-4">Welcome Back</h2>
            <input id="login-code" type="tel" placeholder="PIN" class="w-full p-4 bg-slate-100 rounded-2xl text-center text-2xl font-black tracking-widest outline-none mb-4 uppercase focus:ring-2 ring-indigo-500">
            <input id="login-email" type="email" placeholder="Email" class="w-full p-4 bg-slate-100 rounded-2xl text-center font-bold outline-none mb-6 focus:ring-2 ring-indigo-500">
            <button onclick="handleLogin()" id="login-btn" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-black text-lg shadow-lg active:scale-95 transition-transform">Log In</button>
            <button onclick="showSignup()" class="mt-6 text-indigo-400 font-bold text-sm">Create New Family</button>
        </div>
        
        <div id="signup-form" class="w-full max-w-sm bg-white p-6 rounded-[2rem] shadow-xl hidden h-[500px] overflow-y-auto">
            <div class="flex justify-between items-center mb-4"><button onclick="showLogin()" class="text-slate-400 font-bold text-xs">‚Üê Back</button><h2 class="font-black text-indigo-600">New Family</h2></div>
            <div class="space-y-4">
                <input id="reg-name" placeholder="Family Name" class="w-full p-3 bg-slate-50 rounded-xl font-bold border border-slate-200">
                <input id="reg-email" placeholder="Parent Email" class="w-full p-3 bg-slate-50 rounded-xl font-bold border border-slate-200">
                <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100">
                    <label class="text-[10px] font-bold text-indigo-400 uppercase">Parent PIN (6 Digits)</label>
                    <input id="reg-pin" type="tel" maxlength="6" placeholder="000000" class="w-full bg-transparent text-center text-2xl font-black tracking-[0.5em] outline-none text-indigo-600 mt-2">
                </div>
                <hr class="border-slate-100 my-2">
                <h3 class="font-bold text-sm text-slate-500">First Child</h3>
                <div class="flex gap-2 justify-center my-2"><button onclick="setRegAvatar('üë¶')" class="text-2xl p-2 rounded-full bg-slate-100 border-2 border-transparent hover:border-indigo-500 reg-av selected">üë¶</button><button onclick="setRegAvatar('üëß')" class="text-2xl p-2 rounded-full bg-slate-100 border-2 border-transparent hover:border-indigo-500 reg-av">üëß</button><button onclick="setRegAvatar('ü¶Ñ')" class="text-2xl p-2 rounded-full bg-slate-100 border-2 border-transparent hover:border-indigo-500 reg-av">ü¶Ñ</button></div>
                <input id="reg-c-name" placeholder="Child Name" class="w-full p-3 bg-slate-50 rounded-xl font-bold border border-slate-200">
                <input id="reg-c-bday" type="date" class="w-full p-3 bg-slate-50 rounded-xl font-bold border border-slate-200 text-slate-500">
                <input id="reg-c-pin" type="tel" placeholder="Child PIN (4 digits)" class="w-full p-3 bg-slate-50 rounded-xl font-bold border border-slate-200 text-center">
                <button onclick="doRegister()" id="reg-btn" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-black mt-2">Create Account</button>
            </div>
        </div>
    </div>

    <!-- 2. MAIN APP -->
    <div id="app-container" class="flex-1 flex flex-col hidden">
        <header class="px-5 pt-4 flex justify-between items-center shrink-0">
            <div id="child-switcher-container">
                <div onclick="toggleChildDropdown()" class="flex items-center gap-3 cursor-pointer p-1 rounded-xl active:bg-slate-100 transition">
                    <div id="head-avatar" class="text-4xl bg-white p-1 rounded-2xl shadow-sm">üë§</div>
                    <div>
                        <h1 id="head-name" class="text-xl font-black leading-none">...</h1>
                        <p class="text-[10px] font-bold text-slate-400 uppercase mt-1">My Wallet</p>
                    </div>
                    <div id="dropdown-arrow" class="text-slate-300 text-xs ml-1 hidden">‚ñº</div>
                </div>
                <!-- Dropdown -->
                <div id="child-dropdown">
                    <div id="child-list-container" class="space-y-1"></div>
                    <div class="border-t border-slate-100 mt-2 pt-2">
                        <button onclick="openModal('add-child-modal'); toggleChildDropdown()" class="w-full text-left p-2 rounded-lg text-xs font-bold text-indigo-500 hover:bg-indigo-50">+ Add Child</button>
                    </div>
                </div>
            </div>
            <div id="parent-badge" class="hidden bg-amber-100 text-amber-600 px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-widest border border-amber-200">Parent Mode</div>
        </header>

        <!-- TAB: WALLET -->
        <main id="tab-wallet" class="tab-content active pt-6">
            <div class="cards-grid">
                <div class="dashboard-card card-credit" onclick="showDetail('spend')">
                    <div class="flex justify-between items-start"><div class="w-8 h-6 bg-white/20 rounded-md"></div><div id="overdue-badge" class="hidden bg-red-600 text-white text-[8px] px-2 py-1 rounded font-black uppercase">Overdue</div></div>
                    <div><div class="text-[10px] font-bold uppercase opacity-80">Spend Card</div><div id="bal-spend" class="text-2xl font-black mt-1">$0</div><div class="text-[8px] mt-1 opacity-70">Credit Limit</div></div>
                </div>
                <div class="dashboard-card card-save" onclick="showDetail('save')">
                    <div class="flex justify-between items-start"><div class="text-2xl">üê∑</div><div id="int-badge" class="hidden bg-amber-400 text-amber-900 text-[8px] px-2 py-1 rounded font-black uppercase">+Interest</div></div>
                    <div><div class="text-[10px] font-bold uppercase opacity-50">Savings</div><div id="bal-save" class="text-2xl font-black mt-1 text-emerald-500">$0</div><div class="text-[8px] mt-1 opacity-40 text-slate-500">Tap for details</div></div>
                </div>
            </div>

            <div id="action-area" class="mb-6 px-1"></div>
            <h3 class="text-xs font-bold text-slate-400 uppercase mb-2 px-1">Pending Rewards</h3>
            <div id="pending-list" class="space-y-2 mb-4"></div>
            <h3 class="text-xs font-bold text-slate-400 uppercase mb-2 px-1">Recent Activity</h3>
            <div id="wallet-tx-list" class="space-y-2"></div>
        </main>

        <!-- TAB: DREAMS -->
        <main id="tab-dreams" class="tab-content pt-6">
            <h2 class="text-2xl font-black mb-4">My Dreams üöÄ</h2>
            <div id="goals-list" class="space-y-4 mb-8"></div>
            <button onclick="openModal('goal-modal')" class="w-full py-4 rounded-2xl border-2 border-dashed border-slate-300 text-slate-400 font-bold">+ New Dream</button>
            <h2 class="text-2xl font-black mt-8 mb-4">Achievements üèÜ</h2>
            <div id="achievements-list" class="grid grid-cols-3 gap-2 opacity-60 grayscale"></div>
        </main>

        <!-- TAB: REVIEW -->
        <main id="tab-review" class="tab-content pt-6">
            <h2 class="text-2xl font-black mb-4">Statement üìä</h2>
            <div class="bg-white p-4 rounded-3xl shadow-sm mb-6 h-48"><canvas id="balanceChart"></canvas></div>
            <div id="review-tx-list" class="space-y-3 pb-20"></div>
        </main>

        <!-- TAB: ME -->
        <main id="tab-me" class="tab-content pt-6 flex flex-col h-full">
            <div class="bg-white rounded-[2rem] p-6 text-center mb-6 shadow-sm relative">
                <button onclick="openModal('edit-profile-modal')" class="absolute top-4 right-4 text-slate-300">‚úèÔ∏è</button>
                <div id="me-avatar" class="text-6xl mb-2">üòé</div>
                <h2 id="me-name" class="text-2xl font-black">Name</h2>
                <div id="me-bday" class="text-xs font-bold text-slate-400 mt-1">Birthday</div>
            </div>

            <!-- Parent Entry -->
            <button id="parent-mode-btn" onclick="openModal('parent-verify-modal')" class="w-full bg-slate-800 text-white py-4 rounded-2xl font-bold mb-4 shadow-lg">üëÆ Enter Parent Mode</button>

            <!-- Parent Controls -->
            <div id="parent-controls" class="hidden bg-slate-800 rounded-[2rem] p-6 mb-6 text-white flex-1">
                <h3 class="font-bold uppercase text-xs text-slate-400 mb-4">Central Bank Controls</h3>
                <div class="space-y-4">
                    <button onclick="openModal('add-money-modal')" class="w-full bg-emerald-500 py-3 rounded-xl font-bold">üí∞ Send Money</button>
                    <div><div class="flex justify-between text-xs font-bold mb-1"><span>Savings Rate</span><span id="disp-save-rate">5%</span></div><input id="in-save-rate" type="range" max="20" step="0.5" class="w-full h-2 bg-slate-600 rounded-lg appearance-none cursor-pointer accent-emerald-400"></div>
                    <div><div class="flex justify-between text-xs font-bold mb-1"><span>Penalty Rate</span><span id="disp-pen-rate">0.5%</span></div><input id="in-pen-rate" type="range" max="5" step="0.1" class="w-full h-2 bg-slate-600 rounded-lg appearance-none cursor-pointer accent-rose-400"></div>
                </div>
            </div>

            <!-- Exit Button (Bottom) -->
            <div class="mt-auto pb-4">
                 <button id="exit-parent-btn" onclick="exitParentMode()" class="w-full bg-rose-50 text-rose-500 py-4 rounded-2xl font-bold hidden">Exit Parent Mode</button>
                 <button id="logout-btn" onclick="logout()" class="w-full bg-slate-100 text-slate-400 py-4 rounded-2xl font-bold">Log Out</button>
            </div>
        </main>
    </div>

    <!-- FAB -->
    <div id="fab-container" class="fab-container hidden">
        <div id="fab-menu" class="fab-menu">
            <div class="fab-item"><span class="fab-label">Repay Debt</span><button onclick="openModal('repay-modal'); toggleFab()" class="fab-btn bg-emerald-500">üîÑ</button></div>
            <div class="fab-item"><span class="fab-label">Buy Item</span><button onclick="openModal('expense-modal'); toggleFab()" class="fab-btn bg-indigo-500">üí∏</button></div>
        </div>
        <button id="fab-main" onclick="toggleFab()" class="fab-main">+</button>
    </div>

    <!-- BOTTOM NAV ISLAND -->
    <nav id="bottom-nav" class="hidden">
        <button onclick="showTab('wallet')" id="nav-wallet" class="nav-btn active"><span class="text-2xl mb-1">üëõ</span><div class="nav-indicator"></div></button>
        <button onclick="showTab('dreams')" id="nav-dreams" class="nav-btn"><span class="text-2xl mb-1">üöÄ</span><div class="nav-indicator"></div></button>
        <button onclick="showTab('review')" id="nav-review" class="nav-btn"><span class="text-2xl mb-1">üìä</span><div class="nav-indicator"></div></button>
        <button onclick="showTab('me')" id="nav-me" class="nav-btn"><span class="text-2xl mb-1">üë§</span><div class="nav-indicator"></div></button>
    </nav>

    <!-- MODALS -->
    <div id="detail-modal" class="modal"><div class="modal-box h-[80vh] flex flex-col"><div class="flex justify-between items-center mb-4"><h2 id="detail-title" class="text-xl font-black">Account</h2><button onclick="closeModal('detail-modal')" class="text-2xl">√ó</button></div><div id="detail-list" class="flex-1 overflow-y-auto space-y-3"></div></div></div>

    <div id="parent-verify-modal" class="modal"><div class="modal-box text-center">
        <h2 class="text-xl font-black mb-4">Parent Access</h2><input id="verify-pin" type="tel" maxlength="6" class="w-full text-center text-3xl font-black tracking-widest bg-slate-100 p-4 rounded-xl outline-none mb-4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"><button onclick="verifyParent()" class="w-full bg-slate-800 text-white py-3 rounded-xl font-bold">Unlock</button>
    </div></div>

    <div id="add-money-modal" class="modal"><div class="modal-box">
        <h2 class="text-xl font-black mb-4 text-emerald-500">Send Money</h2><input id="reward-amt" type="number" class="w-full text-4xl font-black text-center border-b mb-4 outline-none" placeholder="0.00"><input id="reward-desc" class="w-full p-3 bg-slate-100 rounded-xl font-bold mb-4" placeholder="Reason (e.g. Chores)"><button onclick="sendReward()" class="w-full bg-emerald-500 text-white py-4 rounded-xl font-bold shadow-lg">Send Reward</button><button onclick="closeModal('add-money-modal')" class="w-full mt-2 text-slate-400 font-bold">Cancel</button>
    </div></div>
    
    <div id="edit-profile-modal" class="modal"><div class="modal-box"><h2 class="font-black text-xl mb-4">Edit Profile</h2><input id="edit-name" class="w-full p-3 bg-slate-100 rounded-xl font-bold mb-2"><input id="edit-bday" type="date" class="w-full p-3 bg-slate-100 rounded-xl font-bold mb-2"><div class="flex gap-2 justify-center mb-4"><button onclick="tempAvatar='üë¶'; updateAvSel()" class="text-2xl p-2 rounded-full border av-opt">üë¶</button><button onclick="tempAvatar='üëß'; updateAvSel()" class="text-2xl p-2 rounded-full border av-opt">üëß</button><button onclick="tempAvatar='ü¶Ñ'; updateAvSel()" class="text-2xl p-2 rounded-full border av-opt">ü¶Ñ</button></div><input id="edit-pin" type="tel" maxlength="4" placeholder="New PIN (4 digits)" class="w-full p-3 bg-rose-50 text-rose-500 rounded-xl font-black text-center tracking-widest mb-2"><div class="text-[10px] text-rose-400 text-center mb-4">Parent will be notified via email.</div><button onclick="saveProfile()" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold">Save Changes</button><button onclick="closeModal('edit-profile-modal')" class="w-full mt-2 text-slate-400 font-bold">Cancel</button></div></div>
    
    <div id="add-child-modal" class="modal"><div class="modal-box"><h2 class="font-black text-xl mb-4">Add Child</h2><input id="ac-name" placeholder="Name" class="w-full p-3 bg-slate-100 rounded-xl font-bold mb-3"><input id="ac-bday" type="date" class="w-full p-3 bg-slate-100 rounded-xl font-bold mb-3"><input id="ac-pin" placeholder="PIN (4 digits)" class="w-full p-3 bg-slate-100 rounded-xl font-bold mb-3 text-center"><button onclick="submitAddChild()" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold">Add</button><button onclick="closeModal('add-child-modal')" class="w-full mt-2 text-slate-400 font-bold">Cancel</button></div></div>
    
    <div id="goal-modal" class="modal"><div class="modal-box text-center"><h2 class="text-xl font-black mb-4">New Dream üéØ</h2><input type="text" id="goal-name" placeholder="Item Name" class="w-full p-4 bg-slate-100 rounded-2xl mb-3 font-bold text-center outline-none"><input type="number" id="goal-target" placeholder="Price ($)" class="w-full p-4 bg-slate-100 rounded-2xl mb-6 font-bold text-center outline-none"><button onclick="submitGoal()" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-black shadow-lg">Save Dream</button><button onclick="closeModal('goal-modal')" class="w-full mt-4 text-slate-400 font-bold">Cancel</button></div></div>
    
    <div id="rate-modal" class="modal"><div class="modal-box text-center"><h2 class="text-xl font-black mb-4">Was it worth it?</h2><div class="flex gap-4 justify-center"><button onclick="submitRate('üëç')" class="text-4xl p-4 bg-emerald-100 rounded-2xl">üëç</button><button onclick="submitRate('üëé')" class="text-4xl p-4 bg-rose-100 rounded-2xl">üëé</button></div><button onclick="closeModal('rate-modal')" class="mt-4 text-slate-400 font-bold text-xs">Skip</button></div></div>
    
    <div id="expense-modal" class="modal"><div class="modal-box text-center"><h2 class="text-xl font-black mb-6 text-slate-800">üí∏ Buy Something</h2><input type="number" id="exp-amt" placeholder="0.00" class="w-full text-5xl font-black text-center outline-none mb-6 bg-transparent text-indigo-600"><input type="text" id="exp-desc" placeholder="What is it?" class="w-full p-4 bg-slate-100 rounded-2xl mb-4 font-bold outline-none text-center"><div class="text-[10px] text-slate-400 font-bold uppercase mb-6 bg-indigo-50 p-2 rounded-lg text-indigo-400">Charged to Spend Card (7 Days Free)</div><button onclick="submitExpense()" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-black text-lg shadow-lg">Swipe Card</button><button onclick="closeModal('expense-modal')" class="w-full mt-4 text-slate-400 font-bold">Cancel</button></div></div>
    <div id="repay-modal" class="modal"><div class="modal-box text-center"><h2 class="text-xl font-black mb-2 text-emerald-600">üîÑ Repay Card</h2><p class="text-xs text-slate-400 font-bold mb-6">From Savings -> Credit Card</p><input type="number" id="repay-amt" placeholder="0.00" class="w-full text-5xl font-black text-center outline-none mb-6 bg-transparent text-emerald-500"><button onclick="submitRepay()" class="w-full bg-emerald-500 text-white py-4 rounded-2xl font-black text-lg shadow-lg shadow-emerald-200">Pay Now</button><button onclick="closeModal('repay-modal')" class="w-full mt-4 text-slate-400 font-bold">Cancel</button></div></div>

    <div id="exit-modal" class="modal"><div class="modal-box text-center"><h2 class="text-xl font-black mb-6">Exit Parent Mode</h2><p class="mb-4 font-bold text-slate-500">Switch to which child?</p><div id="exit-list" class="grid grid-cols-2 gap-3"></div></div></div>

    <script>
        const API_URL = "https://piggybank-backend.vercel.app/api"; 
        let state = { fid: null, cid: null, role: null, data: {}, parentPinHash: '' }; 
        let myChart = null;
        let tempAvatar = '';
        let rateTxId = null;

        function toast(msg, type='info') {
            const el = document.createElement('div'); el.className = 'notif-toast';
            el.innerHTML = `<span class="text-xl">${type==='error'?'üõë':'üîî'}</span><span>${msg}</span>`;
            document.getElementById('toast-container').appendChild(el);
            setTimeout(()=>el.remove(), 4000);
        }
        
        function showLoader(show) { 
            const l = document.getElementById('global-loader'); 
            if(show) { l.classList.remove('fade-out'); } 
            else { setTimeout(()=>l.classList.add('fade-out'), 500); }
        }

        async function api(act, pl) {
            try {
                const res = await fetch(API_URL, {
                    method:'POST', headers:{'Content-Type':'application/json'},
                    body: JSON.stringify({...pl, action:act, familyId:state.fid, childId:state.cid, role:state.role})
                });
                const d = await res.json();
                if(!d.success) throw new Error(d.error);
                return d;
            } catch(e) { toast(e.message, 'error'); throw e; }
        }

        // --- Init & Auth ---
        window.onload = async () => {
            const cached = localStorage.getItem('pb_v3_sess');
            if(cached) {
                try {
                    const s = JSON.parse(cached);
                    state.fid = s.fid; state.cid = s.cid; state.role = 'Child'; // Force role reset to prevent getting stuck
                    await api('login', {type:'AUTO_RECONNECT', familyId:s.fid, childId:s.cid}); // Validate
                    await fetchDash();
                } catch(e) {
                    showAuth();
                } finally {
                    showLoader(false);
                }
            } else {
                showAuth();
                showLoader(false);
            }
            setupNotifications();
        };

        function showAuth() { document.getElementById('auth-screen').classList.remove('hidden'); document.getElementById('app-container').classList.add('hidden'); document.getElementById('bottom-nav').classList.add('hidden'); document.getElementById('fab-container').classList.add('hidden'); }
        function showSignup() { document.getElementById('login-form').classList.add('hidden'); document.getElementById('signup-form').classList.remove('hidden'); }
        function showLogin() { document.getElementById('signup-form').classList.add('hidden'); document.getElementById('login-form').classList.remove('hidden'); }

        async function handleLogin() {
            const c = document.getElementById('login-code').value;
            const e = document.getElementById('login-email').value;
            if(!c || !e) return toast('Enter Code & Email', 'error');
            document.getElementById('login-btn').innerText = '...';
            try {
                const res = await api('login', {code:c, email:e});
                state.fid = res.familyId; state.cid = res.childId; state.role = res.role;
                localStorage.setItem('pb_v3_sess', JSON.stringify(state));
                await fetchDash();
                document.getElementById('auth-screen').classList.add('hidden');
            } catch(err) {}
            document.getElementById('login-btn').innerText = 'Log In';
        }

        let regAv = 'üë¶';
        function setRegAvatar(a) { regAv=a; document.querySelectorAll('.reg-av').forEach(b => b.classList.remove('border-indigo-500')); event.target.classList.add('border-indigo-500'); }
        async function doRegister() {
            const p = { familyName: document.getElementById('reg-name').value, contactEmail: document.getElementById('reg-email').value, parentPin: document.getElementById('reg-pin').value, children: [{ name: document.getElementById('reg-c-name').value, birthday: document.getElementById('reg-c-bday').value, code: document.getElementById('reg-c-pin').value, avatar: regAv }] };
            if(p.parentPin.length !== 6) return toast('Parent PIN must be 6 digits', 'error');
            try {
                const res = await api('createFamily', p);
                state.fid = res.familyId; state.cid = res.childId; state.role = 'Parent';
                localStorage.setItem('pb_v3_sess', JSON.stringify(state));
                await fetchDash();
                document.getElementById('auth-screen').classList.add('hidden');
            } catch(e){}
        }

        async function fetchDash() {
            const d = await api('loadDashboard', {});
            state.data = d;
            state.parentPinHash = d.parentPin;
            render(d);
        }

        function render(d) {
            document.getElementById('app-container').classList.remove('hidden');
            document.getElementById('bottom-nav').classList.remove('hidden');
            document.getElementById('fab-container').classList.remove('hidden');

            const c = d.currentChild;
            const isParent = state.role === 'Parent';

            // Header
            document.getElementById('head-avatar').innerText = c.avatar;
            document.getElementById('head-name').innerText = c.name;
            
            // Parent Mode UI
            if(isParent) {
                document.body.classList.add('dark-mode');
                document.getElementById('dropdown-arrow').classList.remove('hidden');
                document.getElementById('parent-badge').classList.remove('hidden');
                
                document.getElementById('parent-mode-btn').classList.add('hidden');
                document.getElementById('logout-btn').classList.add('hidden');
                document.getElementById('parent-controls').classList.remove('hidden');
                document.getElementById('exit-parent-btn').classList.remove('hidden');
                
                // Admin Inputs
                document.getElementById('disp-save-rate').innerText = (c.savings_rate||5)+'%';
                document.getElementById('in-save-rate').value = c.savings_rate||5;
                document.getElementById('in-save-rate').onchange = (e) => api('updateRates', {childId:c.id, savingsRate:e.target.value}).then(fetchDash);
                document.getElementById('disp-pen-rate').innerText = (c.penalty_rate||0.5)+'%';
                document.getElementById('in-pen-rate').value = c.penalty_rate||0.5;
                document.getElementById('in-pen-rate').onchange = (e) => api('updateRates', {childId:c.id, penaltyRate:e.target.value}).then(fetchDash);
            } else {
                document.body.classList.remove('dark-mode');
                document.getElementById('dropdown-arrow').classList.add('hidden');
                document.getElementById('parent-badge').classList.add('hidden');
                document.getElementById('child-dropdown').classList.remove('open');
                
                document.getElementById('parent-mode-btn').classList.remove('hidden');
                document.getElementById('logout-btn').classList.remove('hidden');
                document.getElementById('parent-controls').classList.add('hidden');
                document.getElementById('exit-parent-btn').classList.add('hidden');
            }

            // Cards & Actions
            document.getElementById('bal-spend').innerText = '$' + Math.abs(c.balance_spend).toFixed(2);
            document.getElementById('bal-save').innerText = '$' + c.balance_save.toFixed(2);
            
            if(c.overdueStats && c.overdueStats.count>0) { document.querySelector('.card-credit').classList.add('overdue'); document.getElementById('overdue-badge').classList.remove('hidden'); } 
            else { document.querySelector('.card-credit').classList.remove('overdue'); document.getElementById('overdue-badge').classList.add('hidden'); }

            if(c.pendingInterest > 0) document.getElementById('int-badge').classList.remove('hidden');
            else document.getElementById('int-badge').classList.add('hidden');

            const actArea = document.getElementById('action-area');
            const pendList = document.getElementById('pending-list');
            actArea.innerHTML = ''; pendList.innerHTML = '';

            const allowanceItem = d.pendingItems.find(i => i.type === 'Allowance');
            if(allowanceItem) {
                actArea.innerHTML = `<button onclick="claimItem('${allowanceItem.id}')" class="claim-btn-lg"><span>üéÅ</span><span>Claim Weekly Allowance $${allowanceItem.amount}</span></button>`;
            } else if (d.pendingItems.length > 0) {
                const r = d.pendingItems[0];
                actArea.innerHTML = `<button onclick="claimItem('${r.id}')" class="claim-btn-lg from-emerald-400 to-teal-500"><span>üíé</span><span>Claim Reward $${r.amount}</span></button>`;
            }
            
            d.pendingItems.forEach(i => {
                if(actArea.innerHTML.includes(i.id)) return;
                pendList.innerHTML += `<div class="bg-white p-3 rounded-xl flex justify-between items-center shadow-sm"><span class="font-bold text-sm text-slate-600">${i.description}</span><button onclick="claimItem('${i.id}')" class="bg-emerald-100 text-emerald-600 px-3 py-1 rounded-lg font-bold text-xs">Claim $${i.amount}</button></div>`;
            });

            const renderTx = (t) => {
                const isExp = t.amount < 0;
                return `<div onclick="if(${isExp && !t.review}) openRate('${t.id}')" class="bg-white p-3 rounded-xl flex justify-between items-center shadow-sm relative overflow-hidden">
                    ${t.isOverdue ? '<div class="absolute left-0 top-0 bottom-0 w-1 bg-rose-500"></div>':''}
                    <div><div class="font-bold text-sm text-slate-700">${t.desc||t.category}</div><div class="text-[10px] font-bold text-slate-400 uppercase">${t.dateStr}</div></div>
                    <div class="text-right"><div class="font-black ${isExp?'text-rose-500':'text-emerald-500'}">${isExp?'':'+'}$${Math.abs(t.amount).toFixed(2)}</div>
                    ${isExp && !t.review ? '<div class="text-[9px] text-indigo-500 font-bold animate-pulse">Rate It?</div>' : ''}</div>
                </div>`;
            };
            document.getElementById('wallet-tx-list').innerHTML = d.transactions.slice(0, 3).map(renderTx).join('');
            document.getElementById('review-tx-list').innerHTML = d.transactions.map(renderTx).join('');
            
            document.getElementById('goals-list').innerHTML = d.goals.filter(g=>g.status!=='Redeemed').map(g => {
                const p = Math.min(100, (c.balance_save/g.target)*100);
                const canBuy = c.balance_save >= g.target;
                return `<div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100"><div class="flex justify-between font-bold mb-2"><span>${g.name}</span><span class="text-indigo-500">$${g.target}</span></div><div class="h-2 bg-slate-100 rounded-full overflow-hidden mb-2"><div class="h-full bg-indigo-500" style="width:${p}%"></div></div>${canBuy ? `<button onclick="redeemGoal('${g.id}', ${g.target}, '${g.name}')" class="w-full bg-emerald-500 text-white py-2 rounded-xl font-bold text-xs shadow-lg">Redeem Now</button>` : `<div class="text-[10px] text-slate-400 text-right">Need $${(g.target - c.balance_save).toFixed(2)}</div>`}</div>`;
            }).join('');
            document.getElementById('achievements-list').innerHTML = d.goals.filter(g=>g.status==='Redeemed').map(g => `<div class="bg-slate-100 p-2 rounded-xl text-center"><div class="text-xl">üèÜ</div><div class="text-[9px] font-bold truncate">${g.name}</div></div>`).join('');

            document.getElementById('me-name').innerText = c.name;
            document.getElementById('me-avatar').innerText = c.avatar;
            document.getElementById('me-bday').innerText = c.birthday || 'No Birthday Set';

            const ctx = document.getElementById('balanceChart').getContext('2d');
            if(myChart) myChart.destroy();
            myChart = new Chart(ctx, { type: 'line', data: { labels: d.chartData.labels, datasets: [{ label: 'Net Worth', data: d.chartData.balances, borderColor: '#6366f1', backgroundColor: 'rgba(99, 102, 241, 0.1)', fill: true, tension: 0.4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {display:false} }, scales: { x: {display:false}, y: {display:false} } } });
        }

        // --- Header Dropdown ---
        function toggleChildDropdown() {
            if(state.role !== 'Parent') return;
            const d = document.getElementById('child-dropdown');
            const list = document.getElementById('child-list-container');
            if(d.classList.contains('open')) {
                d.classList.remove('open');
            } else {
                list.innerHTML = state.data.children.map(k => `<button onclick="switchChild('${k.id}')" class="w-full text-left p-2 rounded-lg flex items-center gap-2 hover:bg-slate-50 ${k.id===state.cid?'bg-slate-100 font-bold':''}"><span class="text-lg">${k.avatar}</span><span class="text-sm">${k.name}</span></button>`).join('');
                d.classList.add('open');
            }
        }
        
        async function switchChild(id) {
            state.cid = id;
            document.getElementById('child-dropdown').classList.remove('open');
            await fetchDash();
        }

        async function exitParentMode() {
            if (state.data.children.length > 1) {
                const list = document.getElementById('exit-list');
                list.innerHTML = state.data.children.map(k => `<button onclick="finishExit('${k.id}')" class="bg-slate-50 p-4 rounded-xl flex flex-col items-center"><span class="text-3xl mb-2">${k.avatar}</span><span class="font-bold">${k.name}</span></button>`).join('');
                openModal('exit-modal');
            } else {
                finishExit(state.data.children[0].id);
            }
        }

        async function finishExit(cid) {
            state.cid = cid;
            state.role = 'Child';
            localStorage.setItem('pb_v3_sess', JSON.stringify(state));
            closeModal('exit-modal');
            await fetchDash();
            toast('Exited Parent Mode');
        }

        // --- Interaction ---
        function showDetail(type) {
            const txs = state.data.transactions.filter(t => t.account === (type==='spend'?'Spend Acc':'Save Acc'));
            document.getElementById('detail-title').innerText = type==='spend'?'Credit Card':'Savings';
            document.getElementById('detail-list').innerHTML = txs.map(t => `<div class="bg-slate-50 p-3 rounded-xl flex justify-between"><span class="font-bold text-sm">${t.desc}</span><span class="font-black ${t.amount<0?'text-rose-500':'text-emerald-500'}">${t.amount}</span></div>`).join('');
            openModal('detail-modal');
        }
        function toggleFab() { const m = document.getElementById('fab-menu'); const btn = document.getElementById('fab-main'); if (m.classList.contains('open')) { m.classList.remove('open'); setTimeout(()=>m.style.display='none', 200); btn.style.transform = 'rotate(0deg)'; } else { m.style.display='flex'; setTimeout(()=>m.classList.add('open'), 10); btn.style.transform = 'rotate(45deg)'; } }
        async function claimItem(id) { try { await api('claimItem', {itemId:id}); confetti(); toast('Claimed!'); fetchDash(); } catch(e){} }
        async function sendReward() { closeModal('add-money-modal'); try { await api('addReward', {amount:document.getElementById('reward-amt').value, description:document.getElementById('reward-desc').value}); toast('Sent!'); fetchDash(); } catch(e){} }
        async function submitGoal() { closeModal('goal-modal'); try { await api('addGoal', {name:document.getElementById('goal-name').value, target:document.getElementById('goal-target').value}); toast('Added'); fetchDash(); } catch(e){} }
        async function redeemGoal(id, amt, name) { if(!confirm(`Buy ${name}?`)) return; try { await api('redeemGoal', {id, amount:amt, name}); confetti(); toast('Enjoy!'); fetchDash(); } catch(e){} }
        function openRate(id) { rateTxId = id; openModal('rate-modal'); }
        async function submitRate(val) { closeModal('rate-modal'); try { await api('updateReview', {id:rateTxId, review:val}); toast('Thanks!'); fetchDash(); } catch(e){} }
        function verifyParent() { if(document.getElementById('verify-pin').value === state.parentPinHash) { state.role = 'Parent'; closeModal('parent-verify-modal'); fetchDash(); toast('Parent Mode Active'); } else { toast('Wrong PIN', 'error'); } }
        async function saveProfile() { closeModal('edit-profile-modal'); try { await api('updateChildProfile', { name: document.getElementById('edit-name').value, birthday: document.getElementById('edit-bday').value, avatar: tempAvatar, newPin: document.getElementById('edit-pin').value }); toast('Updated'); fetchDash(); } catch(e){} }
        function updateAvSel() { document.querySelectorAll('.av-opt').forEach(b => b.classList.remove('border-indigo-500')); event.target.classList.add('border-indigo-500'); }
        async function submitAddChild() { closeModal('add-child-modal'); try { await api('addChild', { name: document.getElementById('ac-name').value, birthday: document.getElementById('ac-bday').value, code: document.getElementById('ac-pin').value, avatar: 'üë∂' }); toast('Child Added'); fetchDash(); } catch(e){} }
        async function submitExpense() { closeModal('expense-modal'); try { await api('addExpense', {amount: document.getElementById('exp-amt').value, description: document.getElementById('exp-desc').value}); toast('Spent!'); fetchDash(); } catch(e){} }
        async function submitRepay() { closeModal('repay-modal'); try { await api('transfer', {amount: document.getElementById('repay-amt').value}); toast('Repaid!'); fetchDash(); } catch(e){} }
        function logout() { localStorage.removeItem('pb_v3_sess'); location.reload(); }
        function setupNotifications() { setInterval(() => { if(!state.data.pendingItems) return; const h = new Date().getHours(); if(h >= 8 && h <= 20 && state.data.pendingItems.length > 0 && !sessionStorage.getItem('n_'+state.data.pendingItems.length)) { toast(`You have rewards waiting!`); sessionStorage.setItem('n_'+state.data.pendingItems.length, 'true'); } }, 60000); }
        function showTab(t) { document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active')); document.getElementById('tab-'+t).classList.add('active'); document.querySelectorAll('.nav-btn').forEach(e => e.classList.remove('active')); const idx = ['wallet','dreams','review','me'].indexOf(t); document.querySelectorAll('.nav-btn')[idx].classList.add('active'); }
        function openModal(id) { document.getElementById(id).classList.add('open'); if(id==='edit-profile-modal'){ const c = state.data.currentChild; document.getElementById('edit-name').value=c.name; document.getElementById('edit-bday').value=c.birthday; tempAvatar=c.avatar; } }
        function closeModal(id) { document.getElementById(id).classList.remove('open'); }
    </script>
</body>
</html>
