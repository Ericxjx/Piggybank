<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>PiggyBank v2</title>
    
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" type="image/png" href="icon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#f8fafc">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&display=swap" rel="stylesheet">
    
    <style>
        body { 
            font-family: 'Fredoka', sans-serif; 
            background-color: #f8fafc; 
            height: 100dvh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
            padding-top: env(safe-area-inset-top);
            transition: background 0.4s ease;
        }

        /* Dark Mode (Parent) */
        body.dark-mode { background-color: #0f172a; color: #cbd5e1; }
        body.dark-mode .bg-white { background-color: #1e293b; color: #fff; border-color: #334155; }
        body.dark-mode .text-slate-800 { color: #f1f5f9; }
        body.dark-mode .text-slate-500 { color: #94a3b8; }
        body.dark-mode .text-slate-400 { color: #64748b; }
        body.dark-mode #bottom-nav { background: rgba(30, 41, 59, 0.9); border-color: rgba(255,255,255,0.1); }
        body.dark-mode .modal-box { background-color: #1e293b; }
        body.dark-mode input { background-color: #334155; color: white; }

        .tab-content { 
            display: none; 
            height: 100%; 
            overflow-y: auto; 
            padding-bottom: 120px; 
            padding-left: 20px; padding-right: 20px;
        }
        .tab-content.active { display: block; animation: fadeIn 0.3s forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Twin Cards Styles */
        .credit-card {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            border-radius: 24px; padding: 24px; color: white;
            box-shadow: 0 15px 30px -5px rgba(79, 70, 229, 0.4);
            min-height: 180px; position: relative; overflow: hidden;
            transition: transform 0.2s;
        }
        .credit-card:active { transform: scale(0.98); }
        .credit-card.overdue {
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
            box-shadow: 0 15px 30px -5px rgba(220, 38, 38, 0.5);
        }
        .chip { width: 45px; height: 32px; background: rgba(255,255,255,0.2); border-radius: 6px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.3); }

        .save-card {
            background: white; border: 1px solid #e2e8f0;
            border-radius: 24px; padding: 24px;
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.05);
            min-height: 180px; position: relative;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        body.dark-mode .save-card { background: #1e293b; border-color: #334155; }
        .interest-bubble {
            position: absolute; top: -10px; right: 10px;
            background: #fbbf24; color: #78350f; font-size: 11px; font-weight: bold;
            padding: 8px 16px; border-radius: 20px;
            box-shadow: 0 4px 10px rgba(251, 191, 36, 0.4);
            animation: bounce 2s infinite; cursor: pointer; z-index: 10;
            border: 2px solid white;
        }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }

        /* FAB */
        .fab-container { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); z-index: 50; display: flex; flex-direction: column; align-items: center; gap: 12px; }
        .fab-main { width: 60px; height: 60px; border-radius: 30px; background: #0f172a; color: white; font-size: 28px; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 25px rgba(15, 23, 42, 0.4); transition: transform 0.2s; }
        body.dark-mode .fab-main { background: #6366f1; box-shadow: 0 10px 25px rgba(99, 102, 241, 0.4); }
        .fab-menu { display: none; flex-direction: column; gap: 12px; align-items: center; margin-bottom: 5px; }
        .fab-menu.open { display: flex; animation: slideUp 0.2s; }
        .fab-item { display: flex; align-items: center; gap: 10px; }
        .fab-label { background: white; padding: 4px 10px; border-radius: 8px; font-size: 11px; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.1); color: #475569; }
        .fab-btn { width: 48px; height: 48px; border-radius: 24px; display: flex; align-items: center; justify-content: center; font-size: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); color: white; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Navigation */
        #bottom-nav { 
            position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%); 
            width: calc(100% - 40px); max-width: 400px; height: 64px; 
            background: rgba(255,255,255,0.8); backdrop-filter: blur(20px); 
            border-radius: 32px; display: flex; justify-content: space-around; align-items: center; 
            z-index: 40; border: 1px solid rgba(255,255,255,0.6); 
            box-shadow: 0 20px 40px -10px rgba(0,0,0,0.1); 
        }
        .nav-btn { opacity: 0.4; transition: all 0.2s; transform: scale(0.9); }
        .nav-btn.active { opacity: 1; transform: scale(1.1); color: #4f46e5; }
        body.dark-mode .nav-btn.active { color: #818cf8; }

        .modal { display: none; position: fixed; inset: 0; z-index: 60; align-items: center; justify-content: center; backdrop-filter: blur(4px); background-color: rgba(0,0,0,0.5); }
        .modal-box { width: 90%; max-width: 22rem; background: white; border-radius: 2rem; padding: 2rem; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); animation: zoomIn 0.2s; }
        @keyframes zoomIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body class="loading">
    <div id="toast-container" class="fixed top-24 left-1/2 -translate-x-1/2 z-[100] flex flex-col gap-2 w-full max-w-xs pointer-events-none"></div>

    <div id="auth-screen" class="fixed inset-0 z-50 bg-slate-50 flex flex-col items-center justify-center p-6 transition-opacity duration-500">
        <div class="text-6xl mb-6">üê∑</div>
        <h1 class="text-4xl font-black text-indigo-600 mb-8 tracking-tight">PiggyBank v2</h1>
        <div class="w-full max-w-sm bg-white p-8 rounded-[2rem] shadow-xl">
            <input id="login-code" type="text" placeholder="PIN CODE" class="w-full p-4 bg-slate-100 rounded-2xl text-center text-2xl font-black tracking-widest outline-none mb-4 uppercase focus:ring-2 ring-indigo-500">
            <input id="login-email" type="email" placeholder="Email" class="w-full p-4 bg-slate-100 rounded-2xl text-center font-bold outline-none mb-6 focus:ring-2 ring-indigo-500">
            <button onclick="handleLogin()" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-black text-lg shadow-lg active:scale-95 transition-transform">Unlock</button>
        </div>
        <button onclick="showSignup()" class="mt-8 text-indigo-400 font-bold text-sm">New Family?</button>
    </div>

    <div id="signup-screen" class="hidden fixed inset-0 z-50 bg-slate-50 flex flex-col items-center justify-center p-6 overflow-y-auto">
        <h1 class="text-3xl font-black text-indigo-600 mb-6 tracking-tight">New Family üè†</h1>
        <div class="w-full max-w-sm bg-white p-6 rounded-[2rem] shadow-xl space-y-4">
            <div>
                <h3 class="text-xs font-bold text-slate-400 uppercase mb-2">Parent / Admin</h3>
                <input id="reg-fam-name" type="text" placeholder="Family Name (e.g. The Smiths)" class="w-full p-3 bg-slate-100 rounded-xl font-bold outline-none text-sm mb-2">
                <input id="reg-email" type="email" placeholder="Parent Email" class="w-full p-3 bg-slate-100 rounded-xl font-bold outline-none text-sm mb-2">
                <input id="reg-pin" type="text" placeholder="Set Admin PIN (e.g. 8888)" class="w-full p-3 bg-slate-100 rounded-xl font-bold outline-none text-sm text-center tracking-widest">
            </div>
            <div class="pt-4 border-t border-slate-100">
                <h3 class="text-xs font-bold text-slate-400 uppercase mb-2">First Child</h3>
                <div class="grid grid-cols-2 gap-2">
                    <input id="reg-kid-name" type="text" placeholder="Name" class="w-full p-3 bg-slate-100 rounded-xl font-bold outline-none text-sm">
                    <input id="reg-kid-code" type="text" placeholder="PIN (e.g. 1234)" class="w-full p-3 bg-slate-100 rounded-xl font-bold outline-none text-sm text-center">
                </div>
                <input id="reg-kid-amt" type="number" placeholder="Weekly Allowance ($)" class="w-full mt-2 p-3 bg-slate-100 rounded-xl font-bold outline-none text-sm text-center">
            </div>
            <button onclick="handleSignup()" class="w-full bg-indigo-600 text-white py-4 rounded-xl font-black text-lg shadow-lg active:scale-95 transition-transform mt-4">Create Account</button>
        </div>
        <button onclick="hideSignup()" class="mt-6 text-slate-400 font-bold text-sm">Back to Login</button>
    </div>

    <div id="app-container" class="flex-1 hidden">
        <header class="px-6 pt-4 pb-2 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div id="header-avatar" class="text-4xl bg-white/50 p-1 rounded-2xl shadow-sm">üë¶</div>
                <div>
                    <h1 id="header-name" class="text-xl font-black leading-none">...</h1>
                    <p id="header-role" class="text-[10px] font-bold text-slate-400 uppercase mt-1 tracking-widest">My Wallet</p>
                </div>
            </div>
        </header>

        <main id="tab-wallet" class="tab-content active pt-4">
            <div id="card-spend" class="credit-card mb-4" onclick="showTab('review')">
                <div class="flex justify-between items-start">
                    <div class="chip"></div>
                    <div id="overdue-badge" class="hidden bg-white/20 backdrop-blur-md px-3 py-1 rounded-full text-[10px] font-black uppercase text-white border border-white/30 flex items-center gap-1">‚ö†Ô∏è Overdue</div>
                </div>
                <div class="mt-4">
                    <div class="text-[10px] font-bold uppercase opacity-70 mb-1 tracking-widest">Credit Balance</div>
                    <div id="bal-spend" class="text-4xl font-black tracking-tight">$0.00</div>
                    <div class="flex justify-between items-end mt-2">
                        <div class="text-[9px] opacity-60 font-bold">**** **** **** 1234</div>
                        <div class="text-[9px] opacity-80 font-bold bg-black/20 px-2 py-1 rounded">7-Day Interest Free</div>
                    </div>
                </div>
            </div>

            <div class="save-card mb-6">
                <div id="interest-bubble" class="interest-bubble hidden" onclick="claimInterest()">+ $0.00 Interest üí∞</div>
                <div class="text-5xl mb-2">üê∑</div>
                <div class="text-[10px] font-bold text-slate-400 uppercase mb-1 tracking-widest">Total Savings</div>
                <div id="bal-save" class="text-3xl font-black text-emerald-500 mb-6">$0.00</div>
                <div id="allowance-area" class="w-full"></div>
            </div>

            <div class="px-2">
                <h3 class="text-xs font-bold text-slate-400 uppercase mb-3 tracking-widest">Recent Activity</h3>
                <div id="recent-tx-list" class="space-y-3"></div>
            </div>
        </main>

        <main id="tab-dreams" class="tab-content pt-4">
            <h2 class="text-2xl font-black mb-6 px-2">My Dreams üöÄ</h2>
            <div id="goals-list" class="space-y-4"></div>
            <button onclick="openModal('goal-modal')" class="w-full bg-slate-100 text-slate-400 py-6 rounded-[2rem] font-bold mt-4 border-2 border-dashed border-slate-200 hover:bg-slate-50 transition">+ Add New Dream</button>
        </main>

        <main id="tab-review" class="tab-content pt-4">
            <h2 class="text-2xl font-black mb-4 px-2">Statement üìä</h2>
            <div class="grid grid-cols-2 gap-3 mb-6">
                <div class="bg-white p-4 rounded-3xl shadow-sm text-center">
                    <div class="text-[10px] font-bold text-slate-400 uppercase">Spent</div>
                    <div id="stat-exp" class="text-xl font-black text-rose-500 mt-1">$0</div>
                </div>
                <div class="bg-white p-4 rounded-3xl shadow-sm text-center">
                    <div class="text-[10px] font-bold text-slate-400 uppercase">Income</div>
                    <div id="stat-inc" class="text-xl font-black text-emerald-500 mt-1">$0</div>
                </div>
            </div>
            <div id="full-tx-list" class="space-y-3"></div>
        </main>

        <main id="tab-me" class="tab-content pt-4">
            <div class="bg-white rounded-[2.5rem] p-8 text-center mb-6 shadow-sm">
                <div id="profile-avatar" class="text-6xl mb-4 inline-block bg-slate-50 p-4 rounded-full">üòé</div>
                <h2 id="profile-name" class="text-2xl font-black text-slate-800">User</h2>
                <div id="profile-fam" class="text-xs font-bold text-slate-400 uppercase mt-1 tracking-widest">Family</div>
            </div>

            <div id="admin-panel" class="hidden mb-6 animate-in slide-in-from-bottom-5">
                <h3 class="text-xs font-bold text-slate-400 uppercase mb-3 ml-2">Central Bank Controls üè¶</h3>
                <div class="bg-slate-800 text-white p-6 rounded-[2rem] shadow-xl">
                    <div class="mb-4">
                        <div class="flex justify-between mb-1">
                            <span class="text-sm font-bold">Savings APY</span>
                            <span class="text-sm font-bold text-emerald-400" id="disp-rate-save">5%</span>
                        </div>
                        <input id="in-rate-save" type="range" min="0" max="20" step="0.5" class="w-full accent-emerald-400 h-2 bg-slate-600 rounded-lg appearance-none cursor-pointer">
                    </div>
                    <div class="mb-6">
                        <div class="flex justify-between mb-1">
                            <span class="text-sm font-bold">Late Penalty</span>
                            <span class="text-sm font-bold text-rose-400" id="disp-rate-penalty">0.5%</span>
                        </div>
                        <input id="in-rate-penalty" type="range" min="0" max="5" step="0.1" class="w-full accent-rose-400 h-2 bg-slate-600 rounded-lg appearance-none cursor-pointer">
                    </div>
                    <button onclick="saveRates()" class="w-full bg-indigo-500 hover:bg-indigo-400 py-3 rounded-xl font-bold transition">Update Policy</button>
                    
                    <div class="mt-6 pt-6 border-t border-slate-700">
                         <h4 class="text-xs font-bold text-slate-500 uppercase mb-3">Switch Account</h4>
                         <div id="child-switcher" class="flex gap-2 overflow-x-auto pb-2"></div>
                    </div>
                </div>
            </div>

            <button onclick="logout()" class="w-full bg-rose-50 text-rose-500 py-4 rounded-2xl font-bold mb-8">Log Out</button>
        </main>
    </div>

    <div id="fab-container" class="fab-container hidden">
        <div id="fab-menu" class="fab-menu">
            <div class="fab-item">
                <span class="fab-label">Repay Debt</span>
                <button onclick="openModal('repay-modal'); toggleFab()" class="fab-btn bg-emerald-500">üîÑ</button>
            </div>
            <div class="fab-item">
                <span class="fab-label">Buy Item</span>
                <button onclick="openModal('expense-modal'); toggleFab()" class="fab-btn bg-indigo-500">üí∏</button>
            </div>
        </div>
        <button id="fab-main" onclick="toggleFab()" class="fab-main">+</button>
    </div>

    <nav id="bottom-nav" class="hidden">
        <button onclick="showTab('wallet')" class="nav-btn active text-2xl">üëõ</button>
        <button onclick="showTab('dreams')" class="nav-btn text-2xl">üöÄ</button>
        <button onclick="showTab('review')" class="nav-btn text-2xl">üìä</button>
        <button onclick="showTab('me')" class="nav-btn text-2xl">üë§</button>
    </nav>

    <div id="expense-modal" class="modal">
        <div class="modal-box text-center">
            <h2 class="text-xl font-black mb-6 text-slate-800">üí∏ Buy Something</h2>
            <input type="number" id="exp-amt" placeholder="0.00" class="w-full text-5xl font-black text-center outline-none mb-6 bg-transparent text-indigo-600">
            <input type="text" id="exp-desc" placeholder="What is it?" class="w-full p-4 bg-slate-100 rounded-2xl mb-4 font-bold outline-none text-center">
            <div class="text-[10px] text-slate-400 font-bold uppercase mb-6 bg-indigo-50 p-2 rounded-lg text-indigo-400">Charged to Spend Card (7 Days Free)</div>
            <button onclick="submitExpense()" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-black text-lg shadow-lg">Swipe Card</button>
            <button onclick="closeModal('expense-modal')" class="w-full mt-4 text-slate-400 font-bold">Cancel</button>
        </div>
    </div>

    <div id="repay-modal" class="modal">
        <div class="modal-box text-center">
            <h2 class="text-xl font-black mb-2 text-emerald-600">üîÑ Repay Card</h2>
            <p class="text-xs text-slate-400 font-bold mb-6">From Savings -> Credit Card</p>
            <input type="number" id="repay-amt" placeholder="0.00" class="w-full text-5xl font-black text-center outline-none mb-6 bg-transparent text-emerald-500">
            <button onclick="submitRepay()" class="w-full bg-emerald-500 text-white py-4 rounded-2xl font-black text-lg shadow-lg shadow-emerald-200">Pay Now</button>
            <button onclick="closeModal('repay-modal')" class="w-full mt-4 text-slate-400 font-bold">Cancel</button>
        </div>
    </div>

    <div id="goal-modal" class="modal">
        <div class="modal-box text-center">
            <h2 class="text-xl font-black mb-6">New Dream üéØ</h2>
            <input type="text" id="goal-name" placeholder="Item Name" class="w-full p-4 bg-slate-100 rounded-2xl mb-3 font-bold text-center outline-none">
            <input type="number" id="goal-target" placeholder="Price ($)" class="w-full p-4 bg-slate-100 rounded-2xl mb-6 font-bold text-center outline-none">
            <button onclick="submitGoal()" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-black shadow-lg">Save Dream</button>
            <button onclick="closeModal('goal-modal')" class="w-full mt-4 text-slate-400 font-bold">Cancel</button>
        </div>
    </div>

    <div id="review-modal" class="modal">
        <div class="modal-box text-center">
            <h2 class="text-lg font-black mb-6 text-slate-700">Was this purchase worth it?</h2>
            <div class="flex gap-4 justify-center mb-4">
                <button onclick="submitReview('üëç')" class="w-20 h-20 text-4xl bg-emerald-100 rounded-2xl hover:scale-110 transition flex items-center justify-center">üëç</button>
                <button onclick="submitReview('üëé')" class="w-20 h-20 text-4xl bg-rose-100 rounded-2xl hover:scale-110 transition flex items-center justify-center">üëé</button>
            </div>
            <button onclick="closeModal('review-modal')" class="text-xs font-bold text-slate-400">Skip</button>
        </div>
    </div>

    <script>
        const API_URL = "https://piggybank-backend.vercel.app/api"; 
        let state = { fid: null, cid: null, role: null, data: {} };
        let currentTxId = null;

        // --- Core Functions ---

        function toast(msg, type='info') {
            const el = document.createElement('div');
            el.className = `p-3 rounded-xl font-bold text-sm text-center shadow-lg animate-bounce ${type==='error'?'bg-rose-500 text-white':'bg-slate-800 text-white'}`;
            el.innerText = msg;
            document.getElementById('toast-container').appendChild(el);
            setTimeout(()=>el.remove(), 3000);
        }

        async function api(action, payload) {
            try {
                const res = await fetch(API_URL, {
                    method: "POST", headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ ...payload, action, familyId: state.fid, childId: state.cid, identity: state.role })
                });
                const d = await res.json();
                if (!d.success) throw new Error(d.error);
                return d;
            } catch(e) {
                toast(e.message, 'error');
                throw e;
            }
        }

        // --- Auth Logic ---
        function showSignup() { document.getElementById('auth-screen').classList.add('hidden'); document.getElementById('signup-screen').classList.remove('hidden'); }
        function hideSignup() { document.getElementById('signup-screen').classList.add('hidden'); document.getElementById('auth-screen').classList.remove('hidden'); }

        async function handleSignup() {
            const famName = document.getElementById('reg-fam-name').value;
            const email = document.getElementById('reg-email').value;
            const pin = document.getElementById('reg-pin').value;
            const kidName = document.getElementById('reg-kid-name').value;
            const kidCode = document.getElementById('reg-kid-code').value;
            const kidAmt = document.getElementById('reg-kid-amt').value;

            if(!famName || !email || !pin || !kidName || !kidCode || !kidAmt) return toast("Please fill all fields", 'error');

            try {
                toast("Creating...", 'info');
                const res = await api('createFamily', { contactEmail: email, familyName: famName, parentPin: pin, children: [{ name: kidName, code: kidCode, weeklyAmt: kidAmt }] });
                
                state.fid = res.familyId; state.cid = res.childId; state.role = 'Parent';
                localStorage.setItem('pb_cache_v2', JSON.stringify(state));
                setTimeout(() => { document.getElementById('signup-screen').classList.add('hidden'); fetchDash(); }, 1000);
            } catch(e) {}
        }

        async function handleLogin() {
            const code = document.getElementById('login-code').value;
            const email = document.getElementById('login-email').value;
            if(!code || !email) return toast("Missing info", 'error');
            try {
                const res = await api('login', {code, email});
                state.fid=res.familyId; state.cid=res.childId; state.role=res.role;
                localStorage.setItem('pb_cache_v2', JSON.stringify(state));
                fetchDash();
            } catch(e) {}
        }

        // --- UI Logic ---

        function showTab(t) {
            document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
            document.getElementById('tab-'+t).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(e => e.classList.remove('active'));
            const idx = ['wallet','dreams','review','me'].indexOf(t);
            if(idx>-1) document.querySelectorAll('.nav-btn')[idx].classList.add('active');
        }

        function toggleFab() {
            const m = document.getElementById('fab-menu');
            const btn = document.getElementById('fab-main');
            if (m.classList.contains('open')) {
                m.classList.remove('open'); setTimeout(()=>m.style.display='none', 200);
                btn.style.transform = 'rotate(0deg)';
            } else {
                m.style.display='flex'; setTimeout(()=>m.classList.add('open'), 10);
                btn.style.transform = 'rotate(45deg)';
            }
        }

        function openModal(id) { document.getElementById(id).classList.add('open'); }
        function closeModal(id) { document.getElementById(id).classList.remove('open'); }

        async function fetchDash() {
            try {
                const d = await api('loadDashboard', {});
                state.data = d;
                render(d);
            } catch(e) {}
        }

        function render(d) {
            document.getElementById('auth-screen').classList.add('opacity-0', 'pointer-events-none');
            document.getElementById('app-container').classList.remove('hidden');
            document.getElementById('fab-container').classList.remove('hidden');
            document.getElementById('bottom-nav').classList.remove('hidden');
            document.getElementById('bottom-nav').style.display = 'flex';

            const c = d.currentChild;
            const isParent = state.role === 'Parent';

            // 1. Theme & Header
            if (isParent) document.body.classList.add('dark-mode'); 
            else document.body.classList.remove('dark-mode');
            
            document.getElementById('header-avatar').innerText = c.avatar || 'üë∂';
            document.getElementById('header-name').innerText = isParent ? `Admin: ${c.name}` : c.name;
            document.getElementById('header-role').innerText = isParent ? 'Central Bank Mode' : 'My Wallet';

            // 2. Wallet Tab
            const balSpend = c.balance_spend || 0; 
            const balSave = c.balance_save || 0;
            const isOverdue = c.overdueStats && c.overdueStats.count > 0;

            document.getElementById('bal-spend').innerText = '$' + Math.abs(balSpend).toFixed(2);
            document.getElementById('bal-save').innerText = '$' + balSave.toFixed(2);
            
            const cardEl = document.getElementById('card-spend');
            if(isOverdue) {
                cardEl.classList.add('overdue');
                document.getElementById('overdue-badge').classList.remove('hidden');
            } else {
                cardEl.classList.remove('overdue');
                document.getElementById('overdue-badge').classList.add('hidden');
            }

            const bubble = document.getElementById('interest-bubble');
            if (c.pendingInterest > 0) {
                bubble.classList.remove('hidden');
                bubble.innerText = `+ $${c.pendingInterest} Interest üí∞`;
            } else {
                bubble.classList.add('hidden');
            }

            const allowContainer = document.getElementById('allowance-area');
            if (!d.allowanceStatus.alreadyClaimed) {
                allowContainer.innerHTML = `<button onclick="claimAllowance()" class="w-full bg-emerald-50 text-emerald-600 py-3 rounded-2xl font-black text-sm animate-pulse border border-emerald-100">üéÅ Claim Weekly Allowance $${c.weeklyAmt}</button>`;
            } else {
                allowContainer.innerHTML = `<div class="text-center text-[10px] text-slate-400 font-bold uppercase py-2">‚úÖ Allowance Collected</div>`;
            }

            // 3. Transactions
            const renderTx = (t) => {
                const isExp = t.amount < 0;
                return `
                <div class="bg-white p-4 rounded-2xl flex justify-between items-center shadow-sm relative overflow-hidden" onclick="${isExp && !t.review ? `openReview('${t.id}')` : ''}">
                    ${t.isOverdue ? '<div class="absolute left-0 top-0 bottom-0 w-1 bg-rose-500"></div>' : ''}
                    <div>
                        <div class="font-bold text-slate-700 text-sm">${t.description || t.category}</div>
                        <div class="text-[10px] text-slate-400 font-bold uppercase">${new Date(t.created_at || t.date).toLocaleDateString()} ‚Ä¢ ${t.isOverdue ? '<span class="text-rose-500 font-black">OVERDUE</span>' : (isExp ? (t.is_fully_paid ? 'Paid' : 'Unpaid') : 'Income')}</div>
                    </div>
                    <div class="text-right">
                        <div class="font-black ${isExp ? 'text-rose-500' : 'text-emerald-500'}">${isExp ? '' : '+'}$${Math.abs(t.amount).toFixed(2)}</div>
                        ${!t.review && isExp ? '<div class="text-[9px] text-indigo-400 font-bold animate-pulse">Rate?</div>' : (t.review ? `<div class="text-xs">${t.review}</div>` : '')}
                    </div>
                </div>`;
            };

            document.getElementById('recent-tx-list').innerHTML = d.transactions.slice(0, 3).map(renderTx).join('');
            document.getElementById('full-tx-list').innerHTML = d.transactions.map(renderTx).join('');
            
            document.getElementById('stat-inc').innerText = '$'+d.stats.income.toFixed(0);
            document.getElementById('stat-exp').innerText = '$'+d.stats.expense.toFixed(0);

            // 4. Goals
            document.getElementById('goals-list').innerHTML = (d.goals || []).map(g => {
                const prog = Math.min(100, (balSave / g.target) * 100);
                const canBuy = balSave >= g.target && g.status !== 'Redeemed';
                return `<div class="bg-white p-5 rounded-[2rem] shadow-sm border border-slate-100 relative overflow-hidden">
                    <div class="flex justify-between items-center mb-2 z-10 relative">
                        <span class="font-bold text-slate-700">${g.name}</span>
                        <span class="font-black text-indigo-500">$${g.target}</span>
                    </div>
                    <div class="w-full bg-slate-100 h-3 rounded-full overflow-hidden relative z-10">
                        <div class="h-full bg-indigo-500" style="width:${prog}%"></div>
                    </div>
                    ${canBuy && isParent ? `<button onclick="redeemGoal('${g.id}', ${g.target}, '${g.name}')" class="mt-3 w-full bg-emerald-500 text-white py-2 rounded-xl font-bold text-xs shadow-lg">Redeem Now</button>` : ''}
                </div>`;
            }).join('');

            // 5. Me / Admin
            document.getElementById('profile-name').innerText = c.name;
            document.getElementById('profile-avatar').innerText = c.avatar;
            document.getElementById('profile-fam').innerText = d.familyName;

            if (isParent) {
                document.getElementById('admin-panel').classList.remove('hidden');
                const rSave = document.getElementById('in-rate-save');
                const rPen = document.getElementById('in-rate-penalty');
                if(document.activeElement !== rSave) rSave.value = c.savings_rate || 5;
                if(document.activeElement !== rPen) rPen.value = c.penalty_rate || 0.5;
                document.getElementById('disp-rate-save').innerText = rSave.value + '%';
                document.getElementById('disp-rate-penalty').innerText = rPen.value + '%';
                rSave.oninput = (e) => document.getElementById('disp-rate-save').innerText = e.target.value + '%';
                rPen.oninput = (e) => document.getElementById('disp-rate-penalty').innerText = e.target.value + '%';
                const switcher = document.getElementById('child-switcher');
                switcher.innerHTML = d.children.map(k => `
                    <button onclick="switchChild('${k.id}')" class="min-w-[60px] p-2 rounded-xl border ${k.id===state.cid?'border-emerald-400 bg-slate-700':'border-slate-600'} flex flex-col items-center">
                        <span class="text-2xl">${k.avatar}</span>
                        <span class="text-[9px] font-bold text-slate-300 truncate w-full text-center">${k.name}</span>
                    </button>
                `).join('');
            } else {
                document.getElementById('admin-panel').classList.add('hidden');
            }
        }

        async function submitExpense() {
            const amt = document.getElementById('exp-amt').value;
            const desc = document.getElementById('exp-desc').value;
            if(!amt) return toast('Enter Amount', 'error');
            closeModal('expense-modal');
            try { await api('addExpense', {amount: amt, description: desc}); toast('Spent!'); fetchDash(); } catch(e){}
        }

        async function submitRepay() {
            const amt = document.getElementById('repay-amt').value;
            if(!amt) return toast('Enter Amount', 'error');
            closeModal('repay-modal');
            try { await api('transfer', {amount: amt, from: 'Save Acc', to: 'Spend Acc'}); toast('Repaid!'); fetchDash(); } catch(e){}
        }

        async function claimAllowance() {
            try { await api('claimAllowance', {}); confetti({origin:{y:0.7}}); toast('Yay!'); fetchDash(); } catch(e){}
        }

        async function claimInterest() {
            try { 
                const res = await api('claimInterest', {}); 
                toast(`+ $${res.amount} Interest!`, 'success'); 
                fetchDash(); 
            } catch(e){}
        }

        async function saveRates() {
            const s = document.getElementById('in-rate-save').value;
            const p = document.getElementById('in-rate-penalty').value;
            try { await api('updateRates', { savingsRate: s, penaltyRate: p }); toast('Policy Updated'); } catch(e){}
        }

        function openReview(id) { currentTxId = id; openModal('review-modal'); }
        async function submitReview(val) {
            closeModal('review-modal');
            try { await api('updateReview', {id: currentTxId, review: val}); fetchDash(); } catch(e){}
        }

        async function submitGoal() {
             const n=document.getElementById('goal-name').value, t=document.getElementById('goal-target').value;
             closeModal('goal-modal');
             try { await api('addGoal', {name:n, target:t}); toast('Dream Saved'); fetchDash(); } catch(e){}
        }
        
        async function redeemGoal(id, amt, name) {
            if(!confirm(`Redeem "${name}"? This will deduct $${amt} from Savings.`)) return;
            try { await api('redeemGoal', {id, amount: amt, name}); confetti(); toast('Enjoy!'); fetchDash(); } catch(e){}
        }

        async function switchChild(id) { state.cid = id; fetchDash(); }
        function logout() { localStorage.removeItem('pb_cache_v2'); location.reload(); }
        
        const cached = localStorage.getItem('pb_cache_v2');
        if(cached) {
            Object.assign(state, JSON.parse(cached));
            fetchDash();
        }
    </script>
</body>
</html>
